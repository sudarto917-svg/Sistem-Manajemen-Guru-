<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sembunyikan page-content secara default */
        .page-content {
            display: none;
        }
        /* Tampilkan page-content yang aktif */
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-container" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="p-8 bg-white rounded-lg shadow-xl text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Login Guru</h1>
            <p class="text-gray-600 mb-8">Silakan login menggunakan akun Google Anda yang terdaftar.</p>
            <button id="btn-login-google" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 flex items-center justify-center space-x-2">
                <ion-icon name="logo-google" class="text-xl"></ion-icon>
                <span>Login dengan Google</span>
            </button>
        </div>
    </div>

    <div id="dashboard-container" class="flex flex-col md:flex-row min-h-screen hidden">
        <aside class="w-full md:w-64 bg-white shadow-lg md:min-h-screen p-4">
            <h1 class="text-2xl font-bold text-blue-700 mb-6 text-center">Dashboard Guru</h1>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 bg-blue-100" data-page="dashboard">
                            <ion-icon name="home-outline" class="mr-3 text-xl"></ion-icon>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="kelas-siswa">
                            <ion-icon name="school-outline" class="mr-3 text-xl"></ion-icon>
                            Kelas & Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="jadwal">
                            <ion-icon name="calendar-outline" class="mr-3 text-xl"></ion-icon>
                            Jadwal Mengajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="absensi">
                            <ion-icon name="checkbox-outline" class="mr-3 text-xl"></ion-icon>
                            Absensi Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="nilai">
                            <ion-icon name="create-outline" class="mr-3 text-xl"></ion-icon>
                            Input Nilai
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="materi">
                            <ion-icon name="book-outline" class="mr-3 text-xl"></ion-icon>
                            Perkembangan Materi
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="sumber-belajar">
                            <ion-icon name="archive-outline" class="mr-3 text-xl"></ion-icon>
                            Bank Sumber Belajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="laporan">
                            <ion-icon name="document-text-outline" class="mr-3 text-xl"></ion-icon>
                            Laporan
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="mt-8 p-3 bg-gray-50 rounded-lg">
                <span class="text-xs text-gray-500">Login sebagai:</span>
                <span id="userEmailDisplay" class="text-sm font-medium text-gray-800 break-all">Memuat...</span>
            </div>
            <button id="btn-logout" class="mt-4 w-full flex items-center justify-center p-3 rounded-lg text-red-600 bg-red-100 hover:bg-red-200 transition duration-300">
                <ion-icon name="log-out-outline" class="mr-3 text-xl"></ion-icon>
                Logout
            </button>
            </aside>

        <main class="flex-1 p-6 md:p-10">
            <div id="dashboard-page" class="page-content active">
                <h2 class="text-3xl font-bold mb-6">Selamat Datang, Guru!</h2>
                <p class="text-gray-600 mb-6">Gunakan menu di samping untuk mengelola data mengajar Anda. Semua data disimpan secara otomatis dan aman.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Jadwal Hari Ini</h3>
                        <p id="jadwal-hari-ini" class="text-gray-600">Memuat jadwal...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Siswa</h3>
                        <p id="total-siswa" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Kelas</h3>
                        <p id="total-kelas" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <div id="kelas-siswa-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Manajemen Kelas & Siswa</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Kelas Baru</h3>
                            <form id="form-tambah-kelas" class="flex items-center space-x-3">
                                <input type="text" id="input-nama-kelas" placeholder="Cth: 10-A IPA" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                    Tambah
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Daftar Kelas</h3>
                            <div id="daftar-kelas-list" class="space-y-3">
                                <p class="text-gray-500">Belum ada data kelas.</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Siswa Baru (Manual)</h3>
                            <form id="form-tambah-siswa" class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Siswa</label>
                                    <input type="text" id="input-nama-siswa" placeholder="Cth: Budi Santoso" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                    <select id="select-kelas-siswa" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih Kelas...</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                        Tambah Siswa
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Import Siswa dari CSV</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pilih File CSV</label>
                                    <input type="file" id="import-csv-file" accept=".csv" class="mt-1 w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100">
                                </div>
                                <p class="text-xs text-gray-500">Format CSV: Kolom pertama <b class="font-medium">Nama Siswa</b>, Kolom kedua <b class="font-medium">Nama Kelas</b> (harus sama persis dengan nama kelas yang sudah ada).</p>
                                <button id="btn-import-csv" class="w-full bg-green-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                                    Mulai Import
                                </button>
                            </div>
                        </div>
                        </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Siswa per Kelas</h3>
                    <div id="daftar-siswa-container" class="space-y-4">
                        <p class="text-gray-500">Belum ada data siswa.</p>
                    </div>
                </div>
            </div>

            <div id="jadwal-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Jadwal Mengajar</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Jadwal Baru</h3>
                    <form id="form-tambah-jadwal" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <select id="jadwal-hari" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Hari</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                        </select>
                        <input type="time" id="jadwal-mulai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="time" id="jadwal-selesai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <select id="jadwal-kelas" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Kelas</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                            Tambah
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-jadwal" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="absensi-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Absensi Siswa</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="absensi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tanggal</label>
                        <input type="date" id="absensi-pilih-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="btn-tampilkan-absensi" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-absensi" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Pilih kelas dan tanggal terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                    <div id="btn-simpan-absensi-container" class="p-4 text-right hidden">
                        <button id="btn-simpan-absensi" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                            Simpan Absensi
                        </button>
                    </div>
                </div>
            </div>

            <div id="nilai-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Input Nilai Siswa</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="nilai-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <button id="btn-tampilkan-nilai" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan Siswa
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-nilai" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Pilih kelas terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <div id="materi-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Perkembangan Materi</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Catat Materi yang Diajarkan</h3>
                    <form id="form-tambah-materi" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                <select id="materi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" id="materi-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Topik / Bab</label>
                            <input type="text" id="materi-topik" placeholder="Cth: Bab 1 - Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Catatan</label>
                            <textarea id="materi-catatan" rows="3" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Catatan singkat..."></textarea>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Materi
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Riwayat Materi</h3>
                    <div id="daftar-materi-container" class="space-y-4">
                        <p class="text-gray-500">Belum ada riwayat materi.</p>
                    </div>
                </div>
            </div>

            <div id="sumber-belajar-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Bank Sumber Belajar</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Sumber Belajar Baru</h3>
                    <form id="form-tambah-sumber" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Judul</label>
                            <input type="text" id="sumber-judul" placeholder="Cth: Video Penjelasan Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Link (URL)</label>
                            <input type="url" id="sumber-link" placeholder="https://youtube.com/watch?v=..." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Deskripsi</label>
                            <textarea id="sumber-deskripsi" rows="2" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Video tentang..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Untuk Kelas (Opsional)</label>
                            <select id="sumber-belajar-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="semua">Semua Kelas</option>
                                </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Sumber
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Materi Tersimpan</h3>
                    <div id="daftar-sumber-belajar" class="space-y-4">
                        <p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>
                    </div>
                </div>
            </div>

            <div id="laporan-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Laporan</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tipe Laporan</label>
                        <select id="laporan-tipe" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="nilai">Laporan Nilai</option>
                            <option value="absensi">Laporan Absensi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="laporan-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <button id="btn-buat-laporan" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Buat Laporan
                    </button>
                    <button id="btn-export-laporan" class="bg-green-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300 hidden">
                        <ion-icon name="download-outline" class="mr-2"></ion-icon>
                        Export CSV
                    </button>
                </div>

                <div id="laporan-output" class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-500">Pilih tipe laporan dan kelas untuk melihat hasil.</p>
                </div>

            </div>

        </main>
    </div> 
    
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 md:w-1/3">
            <p id="notification-message" class="text-lg font-medium"></p>
            <button id="notification-close" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                Tutup
            </button>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
            <h3 class="text-xl font-bold mb-4">Konfirmasi Hapus</h3>
            <p id="confirmation-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold hover:bg-gray-400">
                    Batal
                </button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-700">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
    <div id="catatan-siswa-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/5 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="catatan-modal-title" class="text-xl font-bold">Catatan Perkembangan</h3>
                <button id="catatan-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">×</button>
            </div>
            
            <form id="form-tambah-catatan" class="mb-4 space-y-2">
                <label for="catatan-modal-input" class="block text-sm font-medium text-gray-700">Tambah Catatan Baru:</label>
                <textarea id="catatan-modal-input" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis catatan kualitatif..." required></textarea>
                <input type="hidden" id="catatan-modal-siswaId">
                <input type="hidden" id="catatan-modal-namaSiswa">
                <input type="hidden" id="catatan-modal-kelasId">
                <input type="hidden" id="catatan-modal-namaKelas">
                <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                    Simpan Catatan
                </button>
            </form>
            
            <hr class="my-4">
            <h4 class="text-lg font-semibold mb-3">Riwayat Catatan</h4>
            <div id="catatan-modal-list" class="space-y-3 max-h-64 overflow-y-auto">
                <p class="text-gray-500">Belum ada catatan.</p>
            </div>
        </div>
    </div>
    
    <div id="input-nilai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-3/5 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="nilai-modal-title" class="text-xl font-bold">Input Nilai Siswa</h3>
                <button id="nilai-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">×</button>
            </div>
            
            <form id="form-tambah-nilai" class="mb-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-lg font-semibold">Tambah Penilaian Baru</h4>
                 <input type="hidden" id="nilai-modal-siswaId">
                <input type="hidden" id="nilai-modal-kelasId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="nilai-modal-jenis" class="block text-sm font-medium text-gray-700">Jenis Nilai</label>
                        <select id="nilai-modal-jenis" class="mt-1 w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="Tugas">Tugas</option>
                            <option value="Kuis">Kuis</option>
                            <option value="UTS">UTS</option>
                            <option value="UAS">UAS</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                     <div>
                        <label for="nilai-modal-nama" class="block text-sm font-medium text-gray-700">Nama Penilaian</label>
                        <input type="text" id="nilai-modal-nama" class="mt-1 w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cth: Tugas 1, UTS Ganjil" required>
                    </div>
                     <div>
                        <label for="nilai-modal-nilai" class="block text-sm font-medium text-gray-700">Nilai (0-100)</label>
                        <input type="number" id="nilai-modal-nilai" min="0" max="100" class="mt-1 w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                    Simpan Nilai
                </button>
            </form>
            
            <hr class="my-4">
            <h4 class="text-lg font-semibold mb-3">Daftar Nilai Tersimpan</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Penilaian</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="nilai-modal-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>


    <div id="connection-toast" class="fixed bottom-0 left-1/2 -translate-x-1/2 mb-5 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-20 opacity-0 hidden">
        <span id="connection-toast-message" class="font-medium"></span>
    </div>

    <script type="module">
        // Impor fungsi-fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Impor PapaParse (sudah di-load dari <head>)

        // === KONFIGURASI DAN INISIALISASI FIREBASE ===
        
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
          apiKey: "AIzaSyCa7cNRlEvGfckYDwXppsI0TTxEnP4fIUc",
          authDomain: "sistem-manajemen-guru.firebaseapp.com",
          projectId: "sistem-manajemen-guru",
          storageBucket: "sistem-manajemen-guru.appspot.com",
          messagingSenderId: "527771743263",
          appId: "1:527771743263:web:e8e245cccba74f1041912a"
        };
        // --- AKHIR DARI KONFIGURASI ANDA ---

        // Variabel Global
        let app, auth, db, userId;
        const googleProvider = new GoogleAuthProvider();
        let allKelasData = new Map();
        let currentSiswaAbsensi = [];
        let currentSiswaNilai = []; // Sekarang hanya menyimpan list siswa
        let currentLaporanData = []; // Untuk menyimpan data laporan yang akan diexport
        let currentLaporanFilename = "laporan.csv"; // Nama file default
        
        // === DEFINISI SEMUA FUNGSI ===
        
        function getPrivateCollectionPath(collectionName) {
            if (!userId) throw new Error("User ID belum siap.");
            return `users/${userId}/${collectionName}`;
        }
        function getSiswaSubcollectionPath(siswaId, subcollectionName) {
            if (!userId || !siswaId) throw new Error("User/Siswa ID belum siap.");
             return `users/${userId}/siswa/${siswaId}/${subcollectionName}`;
        }


        // === Toast Notifikasi ===
        const toastElement = document.getElementById('connection-toast');
        const toastMessage = document.getElementById('connection-toast-message');

        function showConnectionToast(message, isError = false) {
            toastMessage.textContent = message;
            toastElement.classList.remove('bg-green-600', 'bg-red-600', 'text-white');
            if (isError) {
                toastElement.classList.add('bg-red-600', 'text-white');
            } else {
                toastElement.classList.add('bg-green-600', 'text-white');
            }
            toastElement.classList.remove('hidden', 'opacity-0', 'translate-y-20');
            setTimeout(() => {
                toastElement.classList.add('opacity-0', 'translate-y-20');
                setTimeout(() => {
                    toastElement.classList.add('hidden');
                }, 300); 
            }, 3000); 
        }

        // === MANAJEMEN MODAL (NOTIFIKASI & KONFIRMASI) ===
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let onConfirmCallback = null;

        function showConfirmation(message, onConfirm) {
            confirmationMessage.textContent = message;
            onConfirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        const catatanModal = document.getElementById('catatan-siswa-modal');
        const catatanModalClose = document.getElementById('catatan-modal-close');
        
        const nilaiModal = document.getElementById('input-nilai-modal');
        const nilaiModalClose = document.getElementById('nilai-modal-close');


        // === MANAJEMEN AUTENTIKASI DAN STATE ===
        
        async function loginGoogle() {
            if (!auth || !googleProvider) {
                console.error("Auth belum siap.");
                showNotification("Sistem autentikasi belum siap.", true);
                return;
            }
            try {
                await signInWithPopup(auth, googleProvider);
                // onAuthStateChanged akan menangani sisanya
            } catch (error) {
                console.error("Gagal login Google:", error);
                showNotification("Gagal login: " + error.message);
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                // onAuthStateChanged akan menangani sisanya
            } catch (error) {
                console.error("Gagal logout:", error);
                showNotification("Gagal logout: " + error.message);
            }
        }
        
        function setupAuthListener() {
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            const userEmailDisplay = document.getElementById('userEmailDisplay');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userEmailDisplay.textContent = user.email || "User";
                    
                    loginContainer.classList.add('hidden');
                    dashboardContainer.classList.remove('hidden');

                    if (!window.firebaseConnected) {
                        showConnectionToast("Berhasil login.", false);
                        window.firebaseConnected = true;
                    }
                    await loadAllInitialData();

                } else {
                    userId = null;
                    loginContainer.classList.remove('hidden');
                    dashboardContainer.classList.add('hidden');
                    window.firebaseConnected = false;
                    
                    document.getElementById('daftar-kelas-list').innerHTML = '<p class="text-gray-500">Silakan login...</p>';
                    document.getElementById('daftar-siswa-container').innerHTML = '<p class="text-gray-500">Silakan login...</p>';
                }
            });
        }
        
        async function loadAllInitialData() {
            if (!userId) return;
            loadKelas();
            loadSiswa();
            loadJadwal();
            loadMateri();
            loadDashboardStats();
            loadSumberBelajar();
        }

        // === LOGIKA NAVIGASI ===
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page') + '-page';
                    pages.forEach(page => page.classList.remove('active'));
                    navLinks.forEach(nav => nav.classList.remove('bg-blue-100'));
                    const activePage = document.getElementById(pageId);
                    if(activePage) {
                        activePage.classList.add('active');
                    }
                    link.classList.add('bg-blue-100');
                    if (pageId === 'dashboard-page') {
                        loadDashboardStats();
                    }
                });
            });
        }

        function setInitialDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('absensi-pilih-tanggal').value = today;
            document.getElementById('materi-tanggal').value = today;
        }

        // === LISTENER UNTUK SEMUA FORM ===
        function setupFormListeners() {
            document.getElementById('form-tambah-kelas').addEventListener('submit', handleTambahKelas);
            document.getElementById('form-tambah-siswa').addEventListener('submit', handleTambahSiswa);
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-materi').addEventListener('submit', handleTambahMateri);
            document.getElementById('btn-tampilkan-absensi').addEventListener('click', handleTampilkanAbsensi);
            
            document.getElementById('btn-tampilkan-nilai').addEventListener('click', handleTampilkanSiswaUntukNilai);
            
            document.getElementById('btn-buat-laporan').addEventListener('click', handleBuatLaporan);
            document.getElementById('btn-export-laporan').addEventListener('click', handleExportLaporan);
            
            document.getElementById('btn-simpan-absensi').addEventListener('click', handleSimpanAbsensi);
            document.getElementById('form-tambah-sumber').addEventListener('submit', handleTambahSumber);
            document.getElementById('form-tambah-catatan').addEventListener('submit', handleTambahCatatan);
            document.getElementById('btn-import-csv').addEventListener('click', handleImportSiswa);
            
            document.getElementById('form-tambah-nilai').addEventListener('submit', handleSimpanNilaiBaru);
            nilaiModalClose.addEventListener('click', () => nilaiModal.classList.add('hidden'));


            // Listener Modal
            notificationClose.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });
            confirmNoBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                onConfirmCallback = null;
            });
            confirmYesBtn.addEventListener('click', () => {
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
                confirmationModal.classList.add('hidden');
                onConfirmCallback = null;
            });
            catatanModalClose.addEventListener('click', () => {
                catatanModal.classList.add('hidden');
            });
        }

        // === BAGIAN 1: DASHBOARD ===
        async function loadDashboardStats() {
            if (!userId) return;
            const kelasRef = collection(db, getPrivateCollectionPath('kelas'));
            onSnapshot(kelasRef, (snapshot) => {
                document.getElementById('total-kelas').textContent = snapshot.size;
            });
            const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
            onSnapshot(siswaRef, (snapshot) => {
                document.getElementById('total-siswa').textContent = snapshot.size;
            });
            const hariIni = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"][new Date().getDay()];
            const jadwalRef = collection(db, getPrivateCollectionPath('jadwal'));
            const q = query(jadwalRef, where("hari", "==", hariIni));
            const querySnapshot = await getDocs(q);
            const jadwalList = [];
            querySnapshot.forEach((doc) => {
                jadwalList.push(doc.data());
            });
            if (jadwalList.length > 0) {
                document.getElementById('jadwal-hari-ini').innerHTML = jadwalList
                    .map(j => `<span class="block">${j.namaKelas} (${j.mulai} - ${j.selesai})</span>`)
                    .join('');
            } else {
                document.getElementById('jadwal-hari-ini').textContent = "Tidak ada jadwal mengajar hari ini.";
            }
        }

        // === BAGIAN 2: KELAS & SISWA ===
        function loadKelas() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('kelas')));
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('daftar-kelas-list');
                const selectDropdowns = document.querySelectorAll('#select-kelas-siswa, #jadwal-kelas, #absensi-pilih-kelas, #nilai-pilih-kelas, #materi-pilih-kelas, #laporan-pilih-kelas, #sumber-belajar-pilih-kelas');
                
                allKelasData.clear();
                listContainer.innerHTML = '';
                
                selectDropdowns.forEach(select => {
                    const firstOption = select.options[0] ? select.options[0].outerHTML : '<option value="">Pilih Kelas</option>';
                    select.innerHTML = firstOption;
                });

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">Belum ada data kelas.</p>';
                    return;
                }

                snapshot.docs.sort((a, b) => a.data().nama.localeCompare(b.data().nama)).forEach(doc => {
                    const kelas = doc.data();
                    const kelasId = doc.id;
                    allKelasData.set(kelas.nama, kelasId); 
                    
                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium">${kelas.nama}</span>
                            <button data-id="${kelasId}" data-nama="${kelas.nama}" class="btn-hapus-kelas text-red-500 hover:text-red-700">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    `;
                    
                    selectDropdowns.forEach(select => {
                        select.innerHTML += `<option value="${kelasId}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

                document.querySelectorAll('.btn-hapus-kelas').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        const nama = button.dataset.nama;
                        showConfirmation(`Yakin ingin menghapus kelas "${nama}"? Ini akan menghapus semua data terkait (siswa, jadwal, absensi, nilai) kelas ini.`, () => {
                            handleHapusKelas(id, nama);
                        });
                    });
                });
            });
        }

        async function handleTambahKelas(e) {
            e.preventDefault();
            const input = document.getElementById('input-nama-kelas');
            const namaKelas = input.value.trim();
            if (!namaKelas || !userId) return;

            try {
                const newDocRef = doc(collection(db, getPrivateCollectionPath('kelas')));
                await setDoc(newDocRef, { nama: namaKelas });
                showConnectionToast("Kelas berhasil ditambahkan.", false);
                input.value = '';
            } catch (error) {
                console.error("Gagal tambah kelas:", error);
                showNotification("Gagal menambahkan kelas: " + error.message);
            }
        }
        
        async function handleHapusKelas(kelasId, namaKelas) {
            if (!userId || !kelasId) return;
            try {
                const batch = writeBatch(db);
                
                // 1. Hapus dokumen kelas
                batch.delete(doc(db, getPrivateCollectionPath('kelas'), kelasId));
                
                // 2. Hapus siswa, jadwal, materi, absensi, nilai, catatan yang terkait
                const collectionsToDelete = ['siswa', 'jadwal', 'materi'];
                for (const coll of collectionsToDelete) {
                    const q = query(collection(db, getPrivateCollectionPath(coll)), where("kelasId", "==", kelasId));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                }

                // 3. Hapus data absensi (disimpan per tanggal)
                const absensiRef = collection(db, getPrivateCollectionPath('absensi'));
                const absensiSnap = await getDocs(absensiRef);
                absensiSnap.forEach(tanggalDoc => {
                    const data = tanggalDoc.data();
                    if (data[kelasId]) {
                        delete data[kelasId];
                        batch.set(tanggalDoc.ref, data);
                    }
                });

                // 4. Hapus data nilai (disimpan per siswa) -> Ini kompleks, kita hapus siswa saja
                // (Sudah ter-handle di 'siswa' di atas)
                
                // 5. Hapus catatan (disimpan per siswa)
                // (Sudah ter-handle di 'siswa' di atas, asumsi catatan ada di sub-collection siswa)
                
                await batch.commit();
                showConnectionToast(`Kelas "${namaKelas}" dan semua data terkait telah dihapus.`, false);
            } catch (error) {
                console.error("Gagal hapus kelas:", error);
                showNotification("Gagal menghapus kelas: " + error.message);
            }
        }

        function loadSiswa() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('siswa')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-siswa-container');
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada data siswa.</p>';
                    return;
                }

                const siswaByKelas = {};
                snapshot.docs.forEach(doc => {
                    const siswa = { id: doc.id, ...doc.data() };
                    if (!siswaByKelas[siswa.kelasId]) {
                        siswaByKelas[siswa.kelasId] = [];
                    }
                    siswaByKelas[siswa.kelasId].push(siswa);
                });

                const sortedKelasIds = Object.keys(siswaByKelas).sort((a, b) => {
                    const namaA = allKelasData.get(a) || '';
                    const namaB = allKelasData.get(b) || '';
                    return namaA.localeCompare(namaB);
                });

                sortedKelasIds.forEach(kelasId => {
                    const namaKelas = siswaByKelas[kelasId][0]?.namaKelas || 'Tanpa Kelas';
                    const siswaList = siswaByKelas[kelasId].sort((a, b) => a.nama.localeCompare(b.nama));
                    
                    let html = `<div class="mb-4">
                                    <h4 class="text-lg font-semibold mb-2 p-2 bg-gray-100 rounded">${namaKelas}</h4>
                                    <ul class="space-y-2">`;
                    
                    siswaList.forEach(siswa => {
                        html += `
                            <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                                <span class="font-medium">${siswa.nama}</span>
                                <div class="flex space-x-2">
                                    <button class="btn-catatan-siswa text-blue-500 hover:text-blue-700"
                                            data-siswa-id="${siswa.id}" 
                                            data-nama-siswa="${siswa.nama}" 
                                            data-kelas-id="${siswa.kelasId}" 
                                            data-nama-kelas="${siswa.namaKelas}">
                                        <ion-icon name="chatbox-ellipses-outline"></ion-icon>
                                    </button>
                                    <button class="btn-hapus-siswa text-red-500 hover:text-red-700" data-id="${siswa.id}" data-nama="${siswa.nama}">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </button>
                                </div>
                            </li>
                        `;
                    });
                    
                    html += `</ul></div>`;
                    container.innerHTML += html;
                });

                // Tambahkan listener ke tombol hapus
                document.querySelectorAll('.btn-hapus-siswa').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        const nama = button.dataset.nama;
                        showConfirmation(`Yakin ingin menghapus siswa "${nama}"?`, () => {
                            handleHapusSiswa(id);
                        });
                    });
                });
                
                // Tambahkan listener ke tombol catatan
                document.querySelectorAll('.btn-catatan-siswa').forEach(button => {
                    // ===== INI ADALAH BARIS YANG DIPERBAIKI =====
                    button.addEventListener('click', () => { 
                        const { siswaId, namaSiswa, kelasId, namaKelas } = button.dataset;
                        openCatatanModal(siswaId, namaSiswa, kelasId, namaKelas);
                    });
                });
            });
        }

        async function handleTambahSiswa(e) {
            e.preventDefault();
            const namaInput = document.getElementById('input-nama-siswa');
            const kelasSelect = document.getElementById('select-kelas-siswa');
            
            const namaSiswa = namaInput.value.trim();
            const kelasId = kelasSelect.value;
            const namaKelas = kelasSelect.options[kelasSelect.selectedIndex].dataset.nama;

            if (!namaSiswa || !kelasId || !userId) {
                showNotification("Nama siswa dan kelas harus diisi.");
                return;
            }

            try {
                const newDocRef = doc(collection(db, getPrivateCollectionPath('siswa')));
                await setDoc(newDocRef, {
                    nama: namaSiswa,
                    kelasId: kelasId,
                    namaKelas: namaKelas
                });
                
                showConnectionToast("Siswa berhasil ditambahkan.", false);
                namaInput.value = '';
                kelasSelect.value = '';
            } catch (error) {
                console.error("Gagal tambah siswa:", error);
                showNotification("Gagal menambahkan siswa: " + error.message);
            }
        }

        async function handleHapusSiswa(siswaId) {
            if (!userId || !siswaId) return;
            try {
                // Hapus juga semua sub-koleksi (nilai, catatan)
                const batch = writeBatch(db);
                const nilaiRef = collection(db, getSiswaSubcollectionPath(siswaId, 'nilai'));
                const catatanRef = collection(db, getSiswaSubcollectionPath(siswaId, 'catatan'));
                
                const nilaiSnap = await getDocs(nilaiRef);
                nilaiSnap.forEach(doc => batch.delete(doc.ref));
                
                const catatanSnap = await getDocs(catatanRef);
                catatanSnap.forEach(doc => batch.delete(doc.ref));
                
                batch.delete(doc(db, getPrivateCollectionPath('siswa'), siswaId));
                
                await batch.commit();
                showConnectionToast("Siswa berhasil dihapus.", false);
            } catch (error) {
                console.error("Gagal hapus siswa:", error);
                showNotification("Gagal menghapus siswa: " + error.message);
            }
        }
        
        async function handleImportSiswa() {
            const fileInput = document.getElementById('import-csv-file');
            if (fileInput.files.length === 0) {
                showNotification("Silakan pilih file CSV terlebih dahulu.");
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!allKelasData || allKelasData.size === 0) {
                 showNotification("Data kelas belum dimuat atau belum ada. Buat kelas terlebih dahulu.");
                return;
            }

            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: async function(results) {
                    const data = results.data;
                    const batch = writeBatch(db);
                    let counter = 0;
                    
                    for (const row of data) {
                        const namaSiswa = row[0]?.trim();
                        const namaKelas = row[1]?.trim();
                        
                        if (!namaSiswa || !namaKelas) {
                            console.warn("Baris dilewati (kosong):", row);
                            continue;
                        }
                        
                        const kelasId = allKelasData.get(namaKelas);
                        
                        if (kelasId) {
                            const newDocRef = doc(collection(db, getPrivateCollectionPath('siswa')));
                            batch.set(newDocRef, {
                                nama: namaSiswa,
                                kelasId: kelasId,
                                namaKelas: namaKelas
                            });
                            counter++;
                        } else {
                            console.warn(`Kelas "${namaKelas}" tidak ditemukan untuk siswa "${namaSiswa}". Siswa dilewati.`);
                        }
                    }
                    
                    if (counter > 0) {
                        try {
                            await batch.commit();
                            showNotification(`${counter} siswa berhasil diimpor.`);
                            fileInput.value = ''; // Reset input file
                        } catch (error) {
                            console.error("Gagal import siswa:", error);
                            showNotification("Gagal melakukan import: " + error.message);
                        }
                    } else {
                        showNotification("Tidak ada siswa yang diimpor. Pastikan nama kelas di CSV sama persis dengan yang ada di sistem.");
                    }
                },
                error: function(err, file) {
                    console.error("PapaParse error:", err);
                    showNotification("Gagal membaca file CSV: " + err.message);
                }
            });
        }

        // === BAGIAN 3: JADWAL MENGAJAR ===
        function loadJadwal() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('jadwal')));
            const hariUrutan = { "Senin": 1, "Selasa": 2, "Rabu": 3, "Kamis": 4, "Jumat": 5, "Sabtu": 6, "Minggu": 7 };

            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-jadwal');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>';
                    return;
                }
                
                const jadwalList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                jadwalList.sort((a, b) => {
                    if (hariUrutan[a.hari] !== hariUrutan[b.hari]) {
                        return hariUrutan[a.hari] - hariUrutan[b.hari];
                    }
                    return a.mulai.localeCompare(b.mulai);
                });

                jadwalList.forEach(jadwal => {
                    container.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.hari}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.mulai} - ${jadwal.selesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.namaKelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="btn-hapus-jadwal text-red-500 hover:text-red-700" data-id="${jadwal.id}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                document.querySelectorAll('.btn-hapus-jadwal').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation(`Yakin ingin menghapus jadwal ini?`, () => {
                            handleHapusJadwal(id);
                        });
                    });
                });
            });
        }

        async function handleTambahJadwal(e) {
            e.preventDefault();
            const hari = document.getElementById('jadwal-hari').value;
            const mulai = document.getElementById('jadwal-mulai').value;
            const selesai = document.getElementById('jadwal-selesai').value;
            const kelasSelect = document.getElementById('jadwal-kelas');
            
            const kelasId = kelasSelect.value;
            const namaKelas = kelasSelect.options[kelasSelect.selectedIndex].dataset.nama;

            if (!hari || !mulai || !selesai || !kelasId || !userId) {
                showNotification("Semua field harus diisi.");
                return;
            }

            try {
                const newDocRef = doc(collection(db, getPrivateCollectionPath('jadwal')));
                await setDoc(newDocRef, {
                    hari,
                    mulai,
                    selesai,
                    kelasId,
                    namaKelas
                });
                
                showConnectionToast("Jadwal berhasil ditambahkan.", false);
                e.target.reset();
            } catch (error) {
                console.error("Gagal tambah jadwal:", error);
                showNotification("Gagal menambahkan jadwal: " + error.message);
            }
        }
        
        async function handleHapusJadwal(jadwalId) {
            if (!userId || !jadwalId) return;
            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('jadwal'), jadwalId));
                showConnectionToast("Jadwal berhasil dihapus.", false);
            } catch (error) {
                console.error("Gagal hapus jadwal:", error);
                showNotification("Gagal menghapus jadwal: " + error.message);
            }
        }

        // === BAGIAN 4: ABSENSI SISWA ===
        async function handleTampilkanAbsensi() {
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;
            
            if (!kelasId || !tanggal || !userId) {
                showNotification("Kelas dan tanggal harus dipilih.");
                return;
            }

            const container = document.getElementById('daftar-absensi');
            container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Memuat data siswa...</td></tr>';
            currentSiswaAbsensi = [];

            try {
                // 1. Ambil data siswa di kelas tsb
                const qSiswa = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
                const siswaSnapshot = await getDocs(qSiswa);
                
                if (siswaSnapshot.empty) {
                    container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                    document.getElementById('btn-simpan-absensi-container').classList.add('hidden');
                    return;
                }
                
                const siswaList = siswaSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.nama.localeCompare(b.nama));
                
                // 2. Ambil data absensi yang sudah ada (jika ada)
                const absensiDocRef = doc(db, getPrivateCollectionPath('absensi'), tanggal);
                const absensiDoc = await getDoc(absensiDocRef);
                const absensiData = absensiDoc.exists() ? absensiDoc.data() : {};
                const absensiKelasIni = absensiData[kelasId] || {};

                container.innerHTML = '';
                
                siswaList.forEach(siswa => {
                    const status = absensiKelasIni[siswa.id] || 'Hadir'; // Default Hadir
                    currentSiswaAbsensi.push({ id: siswa.id, nama: siswa.nama, status: status });
                    
                    container.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">${siswa.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <select class="absensi-status w-full border-gray-300 rounded-md shadow-sm" data-siswa-id="${siswa.id}">
                                    <option value="Hadir" ${status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                                    <option value="Izin" ${status === 'Izin' ? 'selected' : ''}>Izin</option>
                                    <option value="Sakit" ${status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                                    <option value="Alpa" ${status === 'Alpa' ? 'selected' : ''}>Alpa</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('btn-simpan-absensi-container').classList.remove('hidden');

            } catch (error) {
                console.error("Gagal tampilkan absensi:", error);
                showNotification("Gagal mengambil data: " + error.message);
                container.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-red-500">Gagal mengambil data.</td></tr>`;
            }
        }
        
        async function handleSimpanAbsensi() {
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;
            
            if (!kelasId || !tanggal || !userId) {
                showNotification("Kelas dan tanggal tidak valid.");
                return;
            }
            
            const statusSelects = document.querySelectorAll('.absensi-status');
            const dataAbsensiBaru = {};
            
            statusSelects.forEach(select => {
                const siswaId = select.dataset.siswaId;
                const status = select.value;
                dataAbsensiBaru[siswaId] = status;
            });
            
            if (Object.keys(dataAbsensiBaru).length === 0) {
                showNotification("Tidak ada data absensi untuk disimpan.");
                return;
            }
            
            try {
                const absensiDocRef = doc(db, getPrivateCollectionPath('absensi'), tanggal);
                
                // Gunakan setDoc dengan merge: true untuk update/create dokumen
                // Kita akan update field [kelasId] di dalam dokumen [tanggal]
                const dataToSave = {};
                dataToSave[kelasId] = dataAbsensiBaru;
                
                await setDoc(absensiDocRef, dataToSave, { merge: true });
                
                showConnectionToast("Absensi berhasil disimpan.", false);
                
            } catch (error) {
                console.error("Gagal simpan absensi:", error);
                showNotification("Gagal menyimpan absensi: " + error.message);
            }
        }

        // === BAGIAN 5: INPUT NILAI (DIROMBAK) ===
        
        async function handleTampilkanSiswaUntukNilai() {
            const kelasId = document.getElementById('nilai-pilih-kelas').value;
            
            if (!kelasId || !userId) {
                showNotification("Kelas harus dipilih.");
                return;
            }

            const container = document.getElementById('daftar-nilai');
            container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Memuat data siswa...</td></tr>';
            currentSiswaNilai = []; // Reset

            try {
                // 1. Ambil data siswa di kelas tsb
                const qSiswa = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
                const siswaSnapshot = await getDocs(qSiswa);
                
                if (siswaSnapshot.empty) {
                    container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                    return;
                }
                
                const siswaList = siswaSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.nama.localeCompare(b.nama));
                
                container.innerHTML = '';
                currentSiswaNilai = siswaList; // Simpan daftar siswa
                
                siswaList.forEach(siswa => {
                    container.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">${siswa.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="btn-input-nilai-siswa bg-blue-100 text-blue-700 px-3 py-1 rounded-md text-sm font-medium hover:bg-blue-200" 
                                        data-siswa-id="${siswa.id}" 
                                        data-nama-siswa="${siswa.nama}"
                                        data-kelas-id="${siswa.kelasId}">
                                    Input/Lihat Nilai
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Tambahkan listener ke tombol yg baru dibuat
                document.querySelectorAll('.btn-input-nilai-siswa').forEach(button => {
                    button.addEventListener('click', () => {
                        const { siswaId, namaSiswa, kelasId } = button.dataset;
                        openInputNilaiModal(siswaId, namaSiswa, kelasId);
                    });
                });

            } catch (error) {
                console.error("Gagal tampilkan siswa (nilai):", error);
                showNotification("Gagal mengambil data siswa: " + error.message);
                container.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-red-500">Gagal mengambil data.</td></tr>`;
            }
        }
        
        // Fungsi baru untuk membuka modal input nilai
        function openInputNilaiModal(siswaId, namaSiswa, kelasId) {
            document.getElementById('nilai-modal-title').textContent = `Input Nilai: ${namaSiswa}`;
            document.getElementById('nilai-modal-siswaId').value = siswaId;
            document.getElementById('nilai-modal-kelasId').value = kelasId;
            document.getElementById('form-tambah-nilai').reset(); // Bersihkan form
            
            nilaiModal.classList.remove('hidden');
            loadNilaiSiswa(siswaId); // Muat nilai yg sudah ada
        }
        
        // Fungsi baru untuk memuat nilai yg ada di modal
        function loadNilaiSiswa(siswaId) {
            if (!userId || !siswaId) return;
            
            const listContainer = document.getElementById('nilai-modal-list');
            listContainer.innerHTML = '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">Memuat nilai...</td></tr>';
            
            const q = query(collection(db, getSiswaSubcollectionPath(siswaId, 'nilai')));
            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) {
                    listContainer.innerHTML = '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">Belum ada nilai tersimpan.</td></tr>';
                    return;
                }
                
                snapshot.docs.sort((a,b) => a.data().jenis.localeCompare(b.data().jenis) || a.data().nama.localeCompare(b.data().nama))
                    .forEach(doc => {
                    const nilai = doc.data();
                    const nilaiId = doc.id;
                    listContainer.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 whitespace-nowrap">${nilai.jenis}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${nilai.nama}</td>
                            <td class="px-4 py-2 whitespace-nowrap font-medium">${nilai.nilai}</td>
                            <td class="px-4 py-2 whitespace-nowrap">
                                <button class="btn-hapus-nilai text-red-500 hover:text-red-700" data-siswa-id="${siswaId}" data-nilai-id="${nilaiId}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Tambahkan listener hapus
                document.querySelectorAll('.btn-hapus-nilai').forEach(button => {
                    button.addEventListener('click', () => {
                        const { siswaId, nilaiId } = button.dataset;
                        showConfirmation(`Yakin ingin menghapus nilai ini?`, () => {
                            handleHapusNilai(siswaId, nilaiId);
                        });
                    });
                });
            });
        }
        
        // Fungsi baru untuk menyimpan nilai baru dari modal
        async function handleSimpanNilaiBaru(e) {
            e.preventDefault();
            const form = e.target;
            const siswaId = document.getElementById('nilai-modal-siswaId').value;
            const kelasId = document.getElementById('nilai-modal-kelasId').value;
            const jenis = document.getElementById('nilai-modal-jenis').value;
            const nama = document.getElementById('nilai-modal-nama').value.trim();
            const nilai = document.getElementById('nilai-modal-nilai').value;
            
            if (!siswaId || !kelasId || !jenis || !nama || nilai === '') {
                showNotification("Semua field di form nilai harus diisi.");
                return;
            }
            
            try {
                const newDocRef = doc(collection(db, getSiswaSubcollectionPath(siswaId, 'nilai')));
                await setDoc(newDocRef, {
                    jenis: jenis,
                    nama: nama,
                    nilai: Number(nilai),
                    kelasId: kelasId, // Simpan juga kelasId untuk mempermudah query laporan
                    createdAt: serverTimestamp()
                });
                
                showConnectionToast("Nilai berhasil disimpan.", false);
                form.reset();
                
            } catch (error) {
                console.error("Gagal simpan nilai:", error);
                showNotification("Gagal menyimpan nilai: " + error.message);
            }
        }
        
        // Fungsi baru untuk menghapus nilai dari modal
        async function handleHapusNilai(siswaId, nilaiId) {
             if (!userId || !siswaId || !nilaiId) return;
            try {
                await deleteDoc(doc(db, getSiswaSubcollectionPath(siswaId, 'nilai'), nilaiId));
                showConnectionToast("Nilai berhasil dihapus.", false);
            } catch (error) {
                console.error("Gagal hapus nilai:", error);
                showNotification("Gagal menghapus nilai: " + error.message);
            }
        }


        // === BAGIAN 6: PERKEMBANGAN MATERI ===
        function loadMateri() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('materi')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-materi-container');
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada riwayat materi.</p>';
                    return;
                }
                
                const materiByKelas = {};
                snapshot.docs.forEach(doc => {
                    const materi = { id: doc.id, ...doc.data() };
                    if (!materiByKelas[materi.kelasId]) {
                        materiByKelas[materi.kelasId] = [];
                    }
                    materiByKelas[materi.kelasId].push(materi);
                });

                const sortedKelasIds = Object.keys(materiByKelas).sort((a, b) => {
                    const namaA = allKelasData.get(a) || '';
                    const namaB = allKelasData.get(b) || '';
                    return namaA.localeCompare(namaB);
                });
                
                sortedKelasIds.forEach(kelasId => {
                    const namaKelas = materiByKelas[kelasId][0]?.namaKelas || 'Tanpa Kelas';
                    const materiList = materiByKelas[kelasId].sort((a, b) => b.tanggal.localeCompare(a.tanggal)); // Terbaru di atas
                    
                    let html = `<div class="mb-4">
                                    <h4 class="text-lg font-semibold mb-2 p-2 bg-gray-100 rounded">${namaKelas}</h4>
                                    <div class="space-y-3">`;
                    
                    materiList.forEach(materi => {
                        html += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-blue-700">${materi.topik}</span>
                                    <span class="text-sm text-gray-500">${materi.tanggal}</span>
                                </div>
                                <p class="text-gray-600 mb-2">${materi.catatan || 'Tidak ada catatan.'}</p>
                                <button class="btn-hapus-materi text-red-500 hover:text-red-700 text-sm" data-id="${materi.id}">
                                    Hapus
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                    container.innerHTML += html;
                });
                
                document.querySelectorAll('.btn-hapus-materi').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation(`Yakin ingin menghapus catatan materi ini?`, () => {
                            handleHapusMateri(id);
                        });
                    });
                });
            });
        }
        
        async function handleTambahMateri(e) {
            e.preventDefault();
            const kelasSelect = document.getElementById('materi-pilih-kelas');
            const tanggal = document.getElementById('materi-tanggal').value;
            const topik = document.getElementById('materi-topik').value.trim();
            const catatan = document.getElementById('materi-catatan').value.trim();
            
            const kelasId = kelasSelect.value;
            const namaKelas = kelasSelect.options[kelasSelect.selectedIndex].dataset.nama;
            
            if (!kelasId || !tanggal || !topik || !userId) {
                showNotification("Kelas, tanggal, dan topik harus diisi.");
                return;
            }
            
            try {
                const newDocRef = doc(collection(db, getPrivateCollectionPath('materi')));
                await setDoc(newDocRef, {
                    kelasId,
                    namaKelas,
                    tanggal,
                    topik,
                    catatan
                });
                
                showConnectionToast("Catatan materi berhasil disimpan.", false);
                e.target.reset();
                document.getElementById('materi-tanggal').value = new Date().toISOString().split('T')[0];
                
            } catch (error) {
                console.error("Gagal simpan materi:", error);
                showNotification("Gagal menyimpan materi: " + error.message);
            }
        }
        
        async function handleHapusMateri(materiId) {
            if (!userId || !materiId) return;
            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('materi'), materiId));
                showConnectionToast("Materi berhasil dihapus.", false);
            } catch (error) {
                console.error("Gagal hapus materi:", error);
                showNotification("Gagal menghapus materi: " + error.message);
            }
        }

        // === BAGIAN 7: BANK SUMBER BELAJAR ===
        function loadSumberBelajar() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('sumberBelajar')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-sumber-belajar');
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>';
                    return;
                }
                
                const sumberList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sumberList.sort((a,b) => (a.judul || '').localeCompare(b.judul || ''));
                
                sumberList.forEach(sumber => {
                    container.innerHTML += `
                         <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h5 class="font-semibold text-blue-700">${sumber.judul}</h5>
                                    <a href="${sumber.link}" target="_blank" class="text-sm text-blue-500 hover:underline break-all">${sumber.link}</a>
                                    <p class="text-gray-600 mt-1">${sumber.deskripsi || ''}</p>
                                    <span class="text-xs font-medium bg-gray-100 text-gray-700 px-2 py-0.5 rounded mt-2 inline-block">
                                        Untuk: ${sumber.namaKelas || 'Semua Kelas'}
                                    </span>
                                </div>
                                <button class="btn-hapus-sumber text-red-500 hover:text-red-700 ml-4" data-id="${sumber.id}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                document.querySelectorAll('.btn-hapus-sumber').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation(`Yakin ingin menghapus sumber belajar ini?`, () => {
                            handleHapusSumber(id);
                        });
                    });
                });
            });
        }
        
        async function handleTambahSumber(e) {
            e.preventDefault();
            const judul = document.getElementById('sumber-judul').value.trim();
            const link = document.getElementById('sumber-link').value.trim();
            const deskripsi = document.getElementById('sumber-deskripsi').value.trim();
            const kelasSelect = document.getElementById('sumber-belajar-pilih-kelas');
            
            const kelasId = kelasSelect.value;
            const namaKelas = (kelasId === 'semua') ? 'Semua Kelas' : kelasSelect.options[kelasSelect.selectedIndex].dataset.nama;
            
             if (!judul || !link || !userId) {
                showNotification("Judul dan Link harus diisi.");
                return;
            }
            
            try {
                const newDocRef = doc(collection(db, getPrivateCollectionPath('sumberBelajar')));
                await setDoc(newDocRef, {
                    judul,
                    link,
                    deskripsi,
                    kelasId,
                    namaKelas
                });
                
                showConnectionToast("Sumber belajar berhasil disimpan.", false);
                e.target.reset();
                
            } catch (error) {
                console.error("Gagal simpan sumber:", error);
                showNotification("Gagal menyimpan sumber: " + error.message);
            }
        }
        
        async function handleHapusSumber(sumberId) {
            if (!userId || !sumberId) return;
            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('sumberBelajar'), sumberId));
                showConnectionToast("Sumber belajar berhasil dihapus.", false);
            } catch (error) {
                console.error("Gagal hapus sumber:", error);
                showNotification("Gagal menghapus sumber: " + error.message);
            }
        }

        // === BAGIAN 8: CATATAN SISWA (Modal) ===
        function openCatatanModal(siswaId, namaSiswa, kelasId, namaKelas) {
            document.getElementById('catatan-modal-title').textContent = `Catatan Perkembangan: ${namaSiswa}`;
            document.getElementById('catatan-modal-siswaId').value = siswaId;
            document.getElementById('catatan-modal-namaSiswa').value = namaSiswa;
            document.getElementById('catatan-modal-kelasId').value = kelasId;
            document.getElementById('catatan-modal-namaKelas').value = namaKelas;
            document.getElementById('form-tambah-catatan').reset();
            
            catatanModal.classList.remove('hidden');
            loadCatatanSiswa(siswaId);
        }
        
        function loadCatatanSiswa(siswaId) {
            if (!userId || !siswaId) return;
            
            const listContainer = document.getElementById('catatan-modal-list');
            listContainer.innerHTML = '<p class="text-gray-500">Memuat catatan...</p>';
            
            const q = query(collection(db, getSiswaSubcollectionPath(siswaId, 'catatan')));
            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">Belum ada catatan.</p>';
                    return;
                }
                
                snapshot.docs.sort((a,b) => b.data().createdAt.toMillis() - a.data().createdAt.toMillis()) // Terbaru di atas
                    .forEach(doc => {
                    const catatan = doc.data();
                    const catatanId = doc.id;
                    const tanggal = catatan.createdAt.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    listContainer.innerHTML += `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-gray-700">${catatan.teks}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${tanggal}</span>
                                <button class="btn-hapus-catatan text-red-500 hover:text-red-700 text-sm" data-siswa-id="${siswaId}" data-catatan-id="${catatanId}">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                document.querySelectorAll('.btn-hapus-catatan').forEach(button => {
                    button.addEventListener('click', () => {
                        const { siswaId, catatanId } = button.dataset;
                        showConfirmation(`Yakin ingin menghapus catatan ini?`, () => {
                            handleHapusCatatan(siswaId, catatanId);
                        });
                    });
                });
            });
        }
        
        async function handleTambahCatatan(e) {
            e.preventDefault();
            const teks = document.getElementById('catatan-modal-input').value.trim();
            const siswaId = document.getElementById('catatan-modal-siswaId').value;
            const kelasId = document.getElementById('catatan-modal-kelasId').value;
            
            if (!teks || !siswaId || !kelasId || !userId) {
                showNotification("Teks catatan tidak boleh kosong.");
                return;
            }
            
            try {
                const newDocRef = doc(collection(db, getSiswaSubcollectionPath(siswaId, 'catatan')));
                await setDoc(newDocRef, {
                    teks: teks,
                    kelasId: kelasId,
                    createdAt: serverTimestamp()
                });
                e.target.reset();
            } catch (error) {
                console.error("Gagal simpan catatan:", error);
                showNotification("Gagal menyimpan catatan: " + error.message);
            }
        }
        
        async function handleHapusCatatan(siswaId, catatanId) {
            if (!userId || !siswaId || !catatanId) return;
            try {
                await deleteDoc(doc(db, getSiswaSubcollectionPath(siswaId, 'catatan'), catatanId));
            } catch (error) {
                console.error("Gagal hapus catatan:", error);
                showNotification("Gagal menghapus catatan: " + error.message);
            }
        }
        

        // === BAGIAN 9: LAPORAN (DENGAN EXPORT) ===
        
        async function handleBuatLaporan() {
            const tipe = document.getElementById('laporan-tipe').value;
            const kelasId = document.getElementById('laporan-pilih-kelas').value;
            const container = document.getElementById('laporan-output');
            const btnExport = document.getElementById('btn-export-laporan');
            
            container.innerHTML = '<p class="text-gray-500">Membuat laporan...</p>';
            btnExport.classList.add('hidden');
            currentLaporanData = []; // Reset data export

            if (tipe === 'nilai') {
                await buatLaporanNilai(kelasId, container);
            } else if (tipe === 'absensi') {
                await buatLaporanAbsensi(kelasId, container);
            }
            
            if (currentLaporanData.length > 0) {
                btnExport.classList.remove('hidden');
            }
        }
        
        // --- Fungsi Export CSV Baru ---
        function handleExportLaporan() {
            if (currentLaporanData.length === 0) {
                showNotification("Tidak ada data untuk diexport.");
                return;
            }
            
            try {
                const csv = Papa.unparse(currentLaporanData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) { // Cek fitur download
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', currentLaporanFilename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                     showNotification("Fitur download tidak didukung di browser Anda.");
                }
                
            } catch (error) {
                console.error("Gagal export CSV:", error);
                showNotification("Gagal membuat file CSV: " + error.message);
            }
        }

        async function buatLaporanNilai(kelasId, container) {
            const namaKelas = document.getElementById('laporan-pilih-kelas').options[
                document.getElementById('laporan-pilih-kelas').selectedIndex
            ].text;
            
            currentLaporanFilename = `laporan_nilai_${namaKelas.replace(' ', '_')}.csv`;
            
            try {
                // 1. Ambil semua siswa (filter per kelas jika dipilih)
                let siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')));
                if (kelasId) {
                    siswaQuery = query(siswaQuery, where("kelasId", "==", kelasId));
                }
                const siswaSnap = await getDocs(siswaQuery);
                if (siswaSnap.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada siswa untuk ditampilkan.</p>';
                    return;
                }
                const siswaList = siswaSnap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.nama.localeCompare(b.nama));
                
                // 2. Ambil semua nilai (ini berat, tapi perlu untuk model baru)
                // Seharusnya, kita query subcollection nilai untuk SETIAP siswa.
                
                let tableHtml = `<h3 class="text-xl font-semibold mb-4">Laporan Nilai ${namaKelas}</h3>
                                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penilaian</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

                let exportData = [];
                
                for (const siswa of siswaList) {
                    const nilaiQuery = query(collection(db, getSiswaSubcollectionPath(siswa.id, 'nilai')));
                    const nilaiSnap = await getDocs(nilaiQuery);
                    
                    if (nilaiSnap.empty) {
                         tableHtml += `<tr>
                                    <td class="px-4 py-2">${siswa.nama}</td>
                                    <td class="px-4 py-2">${siswa.namaKelas}</td>
                                    <td class="px-4 py-2 text-gray-400" colspan="3">(Belum ada nilai)</td>
                                  </tr>`;
                        exportData.push({ "Nama Siswa": siswa.nama, "Kelas": siswa.namaKelas, "Jenis": "", "Penilaian": "", "Nilai": "" });
                    } else {
                        nilaiSnap.docs.forEach(nilaiDoc => {
                            const nilai = nilaiDoc.data();
                            tableHtml += `<tr>
                                    <td class="px-4 py-2">${siswa.nama}</td>
                                    <td class="px-4 py-2">${siswa.namaKelas}</td>
                                    <td class="px-4 py-2">${nilai.jenis}</td>
                                    <td class="px-4 py-2">${nilai.nama}</td>
                                    <td class="px-4 py-2 font-medium">${nilai.nilai}</td>
                                  </tr>`;
                            exportData.push({ 
                                "Nama Siswa": siswa.nama, 
                                "Kelas": siswa.namaKelas, 
                                "Jenis": nilai.jenis, 
                                "Penilaian": nilai.nama, 
                                "Nilai": nilai.nilai 
                            });
                        });
                    }
                }
                
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                currentLaporanData = exportData; // Simpan untuk export

            } catch (error) {
                console.error("Error buat laporan nilai:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan nilai.</p>';
            }
        }

        async function buatLaporanAbsensi(kelasId, container) {
            const namaKelas = document.getElementById('laporan-pilih-kelas').options[
                document.getElementById('laporan-pilih-kelas').selectedIndex
            ].text;
            
            currentLaporanFilename = `laporan_absensi_${namaKelas.replace(' ', '_')}.csv`;
        
            try {
                // 1. Ambil semua siswa (filter per kelas jika dipilih)
                let siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')));
                if (kelasId) {
                    siswaQuery = query(siswaQuery, where("kelasId", "==", kelasId));
                }
                const siswaSnap = await getDocs(siswaQuery);
                if (siswaSnap.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada siswa untuk ditampilkan.</p>';
                    return;
                }
                const siswaList = siswaSnap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.nama.localeCompare(b.nama));
                const siswaMap = new Map(siswaList.map(s => [s.id, s]));

                // 2. Ambil semua data absensi
                const absensiRef = collection(db, getPrivateCollectionPath('absensi'));
                const absensiSnap = await getDocs(absensiRef);
                
                const absensiPerSiswa = {};
                const semuaTanggal = new Set();
                
                absensiSnap.docs.forEach(doc => {
                    const tanggal = doc.id;
                    const dataTanggal = doc.data();
                    const dataKelas = dataTanggal[kelasId]; // Ambil data untuk kelas yg dipilih
                    
                    if (dataKelas) {
                        semuaTanggal.add(tanggal);
                        for (const siswaId in dataKelas) {
                            if (siswaMap.has(siswaId)) { // Pastikan siswa masih ada di kelas ini
                                if (!absensiPerSiswa[siswaId]) {
                                    absensiPerSiswa[siswaId] = {};
                                }
                                absensiPerSiswa[siswaId][tanggal] = dataKelas[siswaId];
                            }
                        }
                    }
                });
                
                const sortedTanggal = Array.from(semuaTanggal).sort();

                let tableHtml = `<h3 class="text-xl font-semibold mb-4">Laporan Absensi ${namaKelas}</h3>
                                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Nama Siswa</th>`;
                
                let exportData = [];
                const exportHeader = { "Nama Siswa": null, "Kelas": null };

                sortedTanggal.forEach(tgl => {
                    tableHtml += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${tgl}</th>`;
                    exportHeader[tgl] = null;
                });
                
                tableHtml += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                
                siswaList.forEach(siswa => {
                    tableHtml += `<tr><td class="px-4 py-2 whitespace-nowrap sticky left-0 bg-white">${siswa.nama}</td>`;
                    
                    let exportRow = { "Nama Siswa": siswa.nama, "Kelas": siswa.namaKelas };
                    
                    sortedTanggal.forEach(tgl => {
                        const status = absensiPerSiswa[siswa.id]?.[tgl] || 'Hadir'; // Default Hadir
                        tableHtml += `<td class="px-4 py-2 whitespace-nowrap">${status}</td>`;
                        exportRow[tgl] = status;
                    });
                    
                    tableHtml += `</tr>`;
                    exportData.push(exportRow);
                });
                
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                currentLaporanData = exportData;

            } catch (error) {
                console.error("Error buat laporan absensi:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan absensi.</p>';
            }
        }

        // === TITIK MASUK APLIKASI (ENTRY POINT) ===
        // Listener ini sekarang dipanggil di paling akhir, 
        // setelah semua fungsi di atasnya didefinisikan.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Panggil fungsi setup (sekarang sudah aman karena telah didefinisikan di atas)
                setupAuthListener(); 
                setupNavigation();
                setupFormListeners();
                setInitialDate();

                // Tambahkan listener untuk tombol login & logout
                document.getElementById('btn-login-google').addEventListener('click', loginGoogle);
                document.getElementById('btn-logout').addEventListener('click', logout);

            } catch (e) {
                console.error("Error inisialisasi Firebase:", e);
                showConnectionToast("Gagal inisialisasi Firebase. Periksa config.", true);
            }
        });

    </script>
</body>
</html>
