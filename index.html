<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru</title>
    <!-- Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat ikon (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sembunyikan page-content secara default */
        .page-content {
            display: none;
        }
        /* Tampilkan page-content yang aktif */
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Utama -->
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white shadow-lg md:min-h-screen p-4">
            <h1 class="text-2xl font-bold text-blue-700 mb-6 text-center">Dashboard Guru</h1>
            <nav>
                <ul class="space-y-2">
                    <!-- Tombol Navigasi -->
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 bg-blue-100" data-page="dashboard">
                            <ion-icon name="home-outline" class="mr-3 text-xl"></ion-icon>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="kelas-siswa">
                            <ion-icon name="school-outline" class="mr-3 text-xl"></ion-icon>
                            Kelas & Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="jadwal">
                            <ion-icon name="calendar-outline" class="mr-3 text-xl"></ion-icon>
                            Jadwal Mengajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="absensi">
                            <ion-icon name="checkbox-outline" class="mr-3 text-xl"></ion-icon>
                            Absensi Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="nilai">
                            <ion-icon name="create-outline" class="mr-3 text-xl"></ion-icon>
                            Input Nilai
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="materi">
                            <ion-icon name="book-outline" class="mr-3 text-xl"></ion-icon>
                            Perkembangan Materi
                        </a>
                    </li>
                    <!-- BARU: Menu Bank Sumber Belajar -->
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="sumber-belajar">
                            <ion-icon name="archive-outline" class="mr-3 text-xl"></ion-icon>
                            Bank Sumber Belajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="laporan">
                            <ion-icon name="document-text-outline" class="mr-3 text-xl"></ion-icon>
                            Laporan
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="mt-8 p-3 bg-gray-50 rounded-lg">
                <span class="text-xs text-gray-500">ID Guru Anda (UserID):</span>
                <span id="userIdDisplay" class="text-sm font-medium text-gray-800 break-all">Memuat...</span>
            </div>
        </aside>

        <!-- Konten Utama -->
        <main class="flex-1 p-6 md:p-10">
            <!-- Halaman: Dashboard -->
            <div id="dashboard-page" class="page-content active">
                <!-- Konten Dashboard (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Selamat Datang, Guru!</h2>
                <p class="text-gray-600 mb-6">Gunakan menu di samping untuk mengelola data mengajar Anda. Semua data disimpan secara otomatis dan aman.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Jadwal Hari Ini</h3>
                        <p id="jadwal-hari-ini" class="text-gray-600">Memuat jadwal...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Siswa</h3>
                        <p id="total-siswa" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Kelas</h3>
                        <p id="total-kelas" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Halaman: Manajemen Kelas & Siswa -->
            <div id="kelas-siswa-page" class="page-content">
                <!-- Konten Kelas & Siswa (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Manajemen Kelas & Siswa</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Kolom Kiri: Manajemen Kelas -->
                    <div class="space-y-6">
                        <!-- Form Tambah Kelas -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Kelas Baru</h3>
                            <form id="form-tambah-kelas" class="flex items-center space-x-3">
                                <input type="text" id="input-nama-kelas" placeholder="Cth: 10-A IPA" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                    Tambah
                                </button>
                            </form>
                        </div>
                        
                        <!-- Daftar Kelas -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Daftar Kelas</h3>
                            <div id="daftar-kelas-list" class="space-y-3">
                                <p class="text-gray-500">Belum ada data kelas.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Kolom Kanan: Manajemen Siswa -->
                    <div class="space-y-6">
                        <!-- Form Tambah Siswa -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Siswa Baru</h3>
                            <form id="form-tambah-siswa" class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Siswa</label>
                                    <input type="text" id="input-nama-siswa" placeholder="Cth: Budi Santoso" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                    <select id="select-kelas-siswa" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih Kelas...</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                        Tambah Siswa
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Daftar Siswa (dipindah ke bawah) -->
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Siswa per Kelas</h3>
                    <div id="daftar-siswa-container" class="space-y-4">
                        <!-- BARU: Tombol "Catatan" akan ditambahkan di sini oleh JS -->
                        <p class="text-gray-500">Belum ada data siswa.</p>
                    </div>
                </div>
            </div>

            <!-- Halaman: Jadwal Mengajar -->
            <div id="jadwal-page" class="page-content">
                <!-- Konten Jadwal (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Jadwal Mengajar</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Jadwal Baru</h3>
                    <form id="form-tambah-jadwal" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <select id="jadwal-hari" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Hari</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                        </select>
                        <input type="time" id="jadwal-mulai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="time" id="jadwal-selesai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <select id="jadwal-kelas" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Kelas</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                            Tambah
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-jadwal" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Halaman: Absensi Siswa -->
            <div id="absensi-page" class="page-content">
                <!-- Konten Absensi (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Absensi Siswa</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="absensi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tanggal</label>
                        <input type="date" id="absensi-pilih-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="btn-tampilkan-absensi" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-absensi" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Pilih kelas dan tanggal terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                    <div id="btn-simpan-absensi-container" class="p-4 text-right hidden">
                        <button id="btn-simpan-absensi" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                            Simpan Absensi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Halaman: Input Nilai -->
            <div id="nilai-page" class="page-content">
                <!-- Konten Nilai (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Input Nilai Siswa</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="nilai-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <button id="btn-tampilkan-nilai" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 1</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 2</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UTS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UAS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-nilai" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Pilih kelas terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Halaman: Perkembangan Materi -->
            <div id="materi-page" class="page-content">
                <!-- Konten Materi (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Perkembangan Materi</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Catat Materi yang Diajarkan</h3>
                    <form id="form-tambah-materi" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                <select id="materi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" id="materi-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Topik / Bab</label>
                            <input type="text" id="materi-topik" placeholder="Cth: Bab 1 - Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Catatan</label>
                            <textarea id="materi-catatan" rows="3" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Catatan singkat..."></textarea>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Materi
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Riwayat Materi</h3>
                    <div id="daftar-materi-container" class="space-y-4">
                        <p class="text-gray-500">Belum ada riwayat materi.</p>
                    </div>
                </div>
            </div>

            <!-- BARU: Halaman Bank Sumber Belajar -->
            <div id="sumber-belajar-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Bank Sumber Belajar</h2>

                <!-- Form Tambah Sumber Belajar -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Sumber Belajar Baru</h3>
                    <form id="form-tambah-sumber" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Judul</label>
                            <input type="text" id="sumber-judul" placeholder="Cth: Video Penjelasan Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Link (URL)</label>
                            <input type="url" id="sumber-link" placeholder="https://youtube.com/watch?v=..." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Deskripsi</label>
                            <textarea id="sumber-deskripsi" rows="2" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Video tentang..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Untuk Kelas (Opsional)</label>
                            <select id="sumber-belajar-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="semua">Semua Kelas</option>
                                <!-- Daftar kelas akan diisi oleh JS -->
                            </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Sumber
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Daftar Sumber Belajar -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Materi Tersimpan</h3>
                    <div id="daftar-sumber-belajar" class="space-y-4">
                        <p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>
                    </div>
                </div>
            </div>

            <!-- Halaman: Laporan -->
            <div id="laporan-page" class="page-content">
                <!-- Konten Laporan (Tidak berubah) -->
                <h2 class="text-3xl font-bold mb-6">Laporan</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tipe Laporan</label>
                        <select id="laporan-tipe" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="nilai">Laporan Nilai</option>
                            <option value="absensi">Laporan Absensi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="laporan-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <button id="btn-buat-laporan" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Buat Laporan
                    </button>
                </div>

                <div id="laporan-output" class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-500">Pilih tipe laporan dan kelas untuk melihat hasil.</p>
                </div>

            </div>

        </main>
    </div>

    <!-- Modal Notifikasi (Sukses/Error) -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 md:w-1/3">
            <p id="notification-message" class="text-lg font-medium"></p>
            <button id="notification-close" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal Konfirmasi (Hapus) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
            <h3 class="text-xl font-bold mb-4">Konfirmasi Hapus</h3>
            <p id="confirmation-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold hover:bg-gray-400">
                    Batal
                </button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-700">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- BARU: Modal Catatan Perkembangan Siswa -->
    <div id="catatan-siswa-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/5 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="catatan-modal-title" class="text-xl font-bold">Catatan Perkembangan</h3>
                <button id="catatan-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <!-- Form Tambah Catatan -->
            <form id="form-tambah-catatan" class="mb-4 space-y-2">
                <label for="catatan-modal-input" class="block text-sm font-medium text-gray-700">Tambah Catatan Baru:</label>
                <textarea id="catatan-modal-input" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis catatan kualitatif..." required></textarea>
                <!-- Hidden inputs to store student data -->
                <input type="hidden" id="catatan-modal-siswaId">
                <input type="hidden" id="catatan-modal-namaSiswa">
                <input type="hidden" id="catatan-modal-kelasId">
                <input type="hidden" id="catatan-modal-namaKelas">
                <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                    Simpan Catatan
                </button>
            </form>
            
            <!-- Daftar Catatan Lama -->
            <hr class="my-4">
            <h4 class="text-lg font-semibold mb-3">Riwayat Catatan</h4>
            <div id="catatan-modal-list" class="space-y-3 max-h-64 overflow-y-auto">
                <p class="text-gray-500">Belum ada catatan.</p>
            </div>
        </div>
    </div>


    <!-- Toast Notifikasi Koneksi -->
    <div id="connection-toast" class="fixed bottom-0 left-1/2 -translate-x-1/2 mb-5 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-20 opacity-0 hidden">
        <span id="connection-toast-message" class="font-medium"></span>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Impor fungsi-fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === KONFIGURASI DAN INISIALISASI FIREBASE ===
        
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
          apiKey: "AIzaSyCa7cNRlEvGfckYDwXppsI0TTxEnP4fIUc",
          authDomain: "sistem-manajemen-guru.firebaseapp.com",
          projectId: "sistem-manajemen-guru",
          storageBucket: "sistem-manajemen-guru.appspot.com", // Saya perbaiki .firebasestorage.app -> .appspot.com
          messagingSenderId: "527771743263",
          appId: "1:527771743263:web:e8e245cccba74f1041912a"
        };
        // --- AKHIR DARI KONFIGURASI ANDA ---

        let app, auth, db, userId;
        setLogLevel('Debug');

        function getPrivateCollectionPath(collectionName) {
            if (!userId) throw new Error("User ID belum siap.");
            return `users/${userId}/${collectionName}`;
        }

        // === Toast Notifikasi ===
        const toastElement = document.getElementById('connection-toast');
        const toastMessage = document.getElementById('connection-toast-message');

        function showConnectionToast(message, isError = false) {
            toastMessage.textContent = message;
            toastElement.classList.remove('bg-green-600', 'bg-red-600', 'text-white');
            if (isError) {
                toastElement.classList.add('bg-red-600', 'text-white');
            } else {
                toastElement.classList.add('bg-green-600', 'text-white');
            }
            toastElement.classList.remove('hidden', 'opacity-0', 'translate-y-20');
            setTimeout(() => {
                toastElement.classList.add('opacity-0', 'translate-y-20');
                setTimeout(() => {
                    toastElement.classList.add('hidden');
                }, 300); 
            }, 3000); 
        }

        // === MANAJEMEN MODAL (NOTIFIKASI & KONFIRMASI) ===
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }
        notificationClose.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let onConfirmCallback = null;

        function showConfirmation(message, onConfirm) {
            confirmationMessage.textContent = message;
            onConfirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        
        confirmNoBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        });

        confirmYesBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        });

        // BARU: Listener Modal Catatan Siswa
        const catatanModal = document.getElementById('catatan-siswa-modal');
        const catatanModalClose = document.getElementById('catatan-modal-close');
        
        catatanModalClose.addEventListener('click', () => {
            catatanModal.classList.add('hidden');
        });


        // === MANAJEMEN AUTENTIKASI DAN STATE ===
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListener();
                setupNavigation();
                setupFormListeners();
                setInitialDate(); 
            } catch (e) {
                console.error("Error inisialisasi Firebase:", e);
                showConnectionToast("Gagal inisialisasi Firebase. Periksa config.", true);
            }
        });

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    
                    if (!window.firebaseConnected) {
                        showConnectionToast("Berhasil terhubung ke Firebase.", false);
                        window.firebaseConnected = true; 
                    }
                    
                    await loadAllInitialData();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Gagal login:", error);
                        showConnectionToast("Gagal autentikasi Firebase.", true);
                    }
                }
            });
        }

        async function loadAllInitialData() {
            if (!userId) return;
            loadKelas();
            loadSiswa();
            loadJadwal();
            loadMateri();
            loadDashboardStats();
            loadSumberBelajar(); // BARU
        }

        // === LOGIKA NAVIGASI === 
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // BARU: Penambahan 'sumber-belajar'
                    const pageId = link.getAttribute('data-page') + '-page';
                    pages.forEach(page => page.classList.remove('active'));
                    navLinks.forEach(nav => nav.classList.remove('bg-blue-100'));
                    
                    const activePage = document.getElementById(pageId);
                    if(activePage) {
                        activePage.classList.add('active');
                    }
                    link.classList.add('bg-blue-100');
                    
                    if (pageId === 'dashboard-page') {
                        loadDashboardStats();
                    }
                });
            });
        }

        function setInitialDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('absensi-pilih-tanggal').value = today;
            document.getElementById('materi-tanggal').value = today;
        }

        // === LISTENER UNTUK SEMUA FORM === 
        function setupFormListeners() {
            document.getElementById('form-tambah-kelas').addEventListener('submit', handleTambahKelas);
            document.getElementById('form-tambah-siswa').addEventListener('submit', handleTambahSiswa);
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-materi').addEventListener('submit', handleTambahMateri);
            document.getElementById('btn-tampilkan-absensi').addEventListener('click', handleTampilkanAbsensi);
            document.getElementById('btn-tampilkan-nilai').addEventListener('click', handleTampilkanNilai);
            document.getElementById('btn-buat-laporan').addEventListener('click', handleBuatLaporan);
            document.getElementById('btn-simpan-absensi').addEventListener('click', handleSimpanAbsensi);

            // BARU: Listener form fitur baru
            document.getElementById('form-tambah-sumber').addEventListener('submit', handleTambahSumber);
            document.getElementById('form-tambah-catatan').addEventListener('submit', handleTambahCatatan);
        }

        // === BAGIAN 1: DASHBOARD === (Tidak berubah)
        async function loadDashboardStats() {
            if (!userId) return;
            const kelasRef = collection(db, getPrivateCollectionPath('kelas'));
            onSnapshot(kelasRef, (snapshot) => {
                document.getElementById('total-kelas').textContent = snapshot.size;
            });
            const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
            onSnapshot(siswaRef, (snapshot) => {
                document.getElementById('total-siswa').textContent = snapshot.size;
            });
            const hariIni = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"][new Date().getDay()];
            const jadwalRef = collection(db, getPrivateCollectionPath('jadwal'));
            const q = query(jadwalRef, where("hari", "==", hariIni));
            const jadwalHariIniSnap = await getDocs(q);
            const jadwalList = [];
            jadwalHariIniSnap.forEach(doc => {
                const data = doc.data();
                jadwalList.push(`${data.jamMulai} - ${data.jamSelesai}: Kelas ${data.namaKelas}`);
            });
            document.getElementById('jadwal-hari-ini').textContent = jadwalList.length > 0 ? jadwalList.join(', ') : "Tidak ada jadwal hari ini.";
        }


        // === BAGIAN 2: KELAS & SISWA ===
        function loadKelas() {
            const kelasRef = collection(db, getPrivateCollectionPath('kelas'));
            onSnapshot(kelasRef, (snapshot) => {
                const selects = [
                    document.getElementById('select-kelas-siswa'),
                    document.getElementById('jadwal-kelas'),
                    document.getElementById('absensi-pilih-kelas'),
                    document.getElementById('nilai-pilih-kelas'),
                    document.getElementById('materi-pilih-kelas'),
                    document.getElementById('laporan-pilih-kelas'),
                    document.getElementById('sumber-belajar-pilih-kelas') // BARU
                ];
                
                const kelasListContainer = document.getElementById('daftar-kelas-list');

                // Kosongkan semua (kecuali opsi default)
                selects.forEach(s => {
                    const firstOption = s.options[0];
                    s.innerHTML = ''; // Hapus semua
                    s.appendChild(firstOption); // Tambahkan lagi opsi default
                });
                kelasListContainer.innerHTML = '';

                if (snapshot.empty) {
                    kelasListContainer.innerHTML = '<p class="text-gray-500">Belum ada data kelas.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const kelas = doc.data();
                    const kelasId = doc.id;
                    const namaKelas = kelas.nama;
                    
                    const option = `<option value="${kelasId}" data-nama="${namaKelas}">${namaKelas}</option>`;
                    selects.forEach(s => s.insertAdjacentHTML('beforeend', option));

                    kelasListContainer.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium">${namaKelas}</span>
                            <button class="btn-hapus-kelas text-red-500 hover:text-red-700 text-sm font-semibold" data-id="${kelasId}" data-nama="${namaKelas}">
                                Hapus
                            </button>
                        </div>
                    `;
                });

                document.querySelectorAll('.btn-hapus-kelas').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { id, nama } = e.currentTarget.dataset;
                        handleHapusKelas(id, nama);
                    });
                });
            });
        }

        async function handleTambahKelas(e) {
            e.preventDefault();
            const input = document.getElementById('input-nama-kelas');
            const namaKelas = input.value.trim();
            if (!namaKelas) return;
            try {
                await addDoc(collection(db, getPrivateCollectionPath('kelas')), {
                    nama: namaKelas
                });
                showNotification("Kelas berhasil ditambahkan!");
                input.value = '';
            } catch (error) {
                console.error("Error tambah kelas:", error);
                showNotification("Gagal menambahkan kelas.");
            }
        }

        async function handleHapusKelas(kelasId, namaKelas) {
            showConfirmation(`Apakah Anda yakin ingin menghapus kelas "${namaKelas}"? SEMUA data siswa, nilai, absensi, jadwal, dan materi terkait kelas ini akan dihapus permanen.`, async () => {
                showNotification("Menghapus data kelas...");
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, getPrivateCollectionPath('kelas'), kelasId));
                    const siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
                    const siswaSnap = await getDocs(siswaQuery);
                    const siswaIds = [];
                    siswaSnap.forEach(doc => {
                        batch.delete(doc.ref);
                        siswaIds.push(doc.id);
                    });

                    // Hapus data terkait siswa
                    siswaIds.forEach(id => {
                        batch.delete(doc(db, getPrivateCollectionPath('nilai'), id));
                        // Hapus catatan siswa
                        const catatanQuery = query(collection(db, getPrivateCollectionPath('catatan_siswa')), where("siswaId", "==", id));
                        getDocs(catatanQuery).then(snap => snap.forEach(d => batch.delete(d.ref)));
                    });
                    
                    const absensiQuery = query(collection(db, getPrivateCollectionPath('absensi')), where("kelasId", "==", kelasId));
                    const absensiSnap = await getDocs(absensiQuery);
                    absensiSnap.forEach(doc => batch.delete(doc.ref));
                    
                    const jadwalQuery = query(collection(db, getPrivateCollectionPath('jadwal')), where("kelasId", "==", kelasId));
                    const jadwalSnap = await getDocs(jadwalQuery);
                    jadwalSnap.forEach(doc => batch.delete(doc.ref));
                    
                    const materiQuery = query(collection(db, getPrivateCollectionPath('materi')), where("kelasId", "==", kelasId));
                    const materiSnap = await getDocs(materiQuery);
                    materiSnap.forEach(doc => batch.delete(doc.ref));

                    // Hapus sumber belajar terkait
                    const sumberQuery = query(collection(db, getPrivateCollectionPath('sumber_belajar')), where("kelasId", "==", kelasId));
                    const sumberSnap = await getDocs(sumberQuery);
                    sumberSnap.forEach(doc => batch.delete(doc.ref));

                    await batch.commit();
                    showNotification(`Kelas "${namaKelas}" dan semua data terkait berhasil dihapus.`);
                } catch (error) {
                    console.error("Error hapus kelas (cascade):", error);
                    showNotification("Gagal menghapus kelas.");
                }
            });
        }

        function loadSiswa() {
            const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
            onSnapshot(siswaRef, async (snapshot) => {
                const container = document.getElementById('daftar-siswa-container');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada data siswa.</p>';
                    return;
                }

                container.innerHTML = '';
                const siswaByKelas = {};

                for (const docSnap of snapshot.docs) {
                    const siswa = docSnap.data();
                    const kelasId = siswa.kelasId;
                    
                    if (!siswaByKelas[kelasId]) {
                        siswaByKelas[kelasId] = { namaKelas: await getNamaKelas(kelasId), siswa: [] };
                    }
                    siswaByKelas[kelasId].siswa.push({ ...siswa, id: docSnap.id });
                }

                for (const kelasId in siswaByKelas) {
                    const data = siswaByKelas[kelasId];
                    if (data.namaKelas === "Kelas Tidak Ditemukan") continue; 
                    
                    let siswaHtml = `<h4 class="text-lg font-semibold mt-4">${data.namaKelas}</h4>
                                     <ul class="list-disc list-inside pl-4 space-y-1">`;
                    data.siswa.forEach(s => {
                        siswaHtml += `
                            <li class="flex justify-between items-center py-1">
                                <span>${s.nama}</span>
                                <span class="space-x-2">
                                    <!-- BARU: Tombol Catatan -->
                                    <button class="btn-lihat-catatan text-blue-600 hover:text-blue-800 text-sm font-semibold" 
                                            data-siswa-id="${s.id}" 
                                            data-nama-siswa="${s.nama}"
                                            data-kelas-id="${s.kelasId}"
                                            data-nama-kelas="${data.namaKelas}">
                                        Catatan
                                    </button>
                                    <button class="btn-hapus-siswa text-red-500 hover:text-red-700 text-sm font-semibold" 
                                            data-id="${s.id}" 
                                            data-nama="${s.nama}">
                                        Hapus
                                    </button>
                                </span>
                            </li>`;
                    });
                    siswaHtml += `</ul>`;
                    container.insertAdjacentHTML('beforeend', siswaHtml);
                }

                // BARU: Listener untuk tombol "Catatan"
                document.querySelectorAll('.btn-lihat-catatan').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        handleLihatCatatan(e.currentTarget.dataset);
                    });
                });

                document.querySelectorAll('.btn-hapus-siswa').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { id, nama } = e.currentTarget.dataset;
                        handleHapusSiswa(id, nama)
                    });
                });
            });
        }

        async function handleTambahSiswa(e) {
            e.preventDefault();
            const namaSiswa = document.getElementById('input-nama-siswa').value.trim();
            const selectKelas = document.getElementById('select-kelas-siswa');
            const kelasId = selectKelas.value;
            const namaKelas = selectKelas.options[selectKelas.selectedIndex].text;
            if (!namaSiswa || !kelasId) {
                showNotification("Nama siswa dan kelas harus diisi.");
                return;
            }
            try {
                await addDoc(collection(db, getPrivateCollectionPath('siswa')), {
                    nama: namaSiswa,
                    kelasId: kelasId,
                    namaKelas: namaKelas 
                });
                showNotification("Siswa berhasil ditambahkan!");
                document.getElementById('form-tambah-siswa').reset();
            } catch (error) {
                console.error("Error tambah siswa:", error);
                showNotification("Gagal menambahkan siswa.");
            }
        }

        async function handleHapusSiswa(siswaId, namaSiswa) {
            showConfirmation(`Apakah Anda yakin ingin menghapus siswa "${namaSiswa}"? Data nilai, absensi, dan catatan siswa ini juga akan dihapus.`, async () => {
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, getPrivateCollectionPath('siswa'), siswaId));
                    batch.delete(doc(db, getPrivateCollectionPath('nilai'), siswaId));
                    
                    const absensiQuery = query(collection(db, getPrivateCollectionPath('absensi')), where("siswaId", "==", siswaId));
                    const absensiSnap = await getDocs(absensiQuery);
                    absensiSnap.forEach(doc => batch.delete(doc.ref));

                    // BARU: Hapus catatan
                    const catatanQuery = query(collection(db, getPrivateCollectionPath('catatan_siswa')), where("siswaId", "==", siswaId));
                    const catatanSnap = await getDocs(catatanQuery);
                    catatanSnap.forEach(doc => batch.delete(doc.ref));

                    await batch.commit();
                    showNotification("Siswa berhasil dihapus.");
                } catch (error) {
                    console.error("Error hapus siswa:", error);
                    showNotification("Gagal menghapus siswa.");
                }
            });
        }

        async function getNamaKelas(kelasId) {
            try {
                const docRef = doc(db, getPrivateCollectionPath('kelas'), kelasId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().nama : "Kelas Tidak Ditemukan";
            } catch (e) {
                return "Error Kelas";
            }
        }

        // === BAGIAN 3: JADWAL MENGAJAR === (Tidak berubah)
        function loadJadwal() {
            const jadwalRef = collection(db, getPrivateCollectionPath('jadwal'));
            onSnapshot(jadwalRef, (snapshot) => {
                const container = document.getElementById('daftar-jadwal');
                if (snapshot.empty) {
                    container.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>';
                    return;
                }
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const jadwal = docSnap.data();
                    container.innerHTML += `
                        <tr id="jadwal-${docSnap.id}">
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.hari}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.jamMulai} - ${jadwal.jamSelesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.namaKelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="btn-hapus-jadwal text-red-500 hover:text-red-700" data-id="${docSnap.id}">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
                document.querySelectorAll('.btn-hapus-jadwal').forEach(btn => {
                    btn.addEventListener('click', (e) => handleHapusJadwal(e.target.dataset.id));
                });
            });
        }
        
        async function handleTambahJadwal(e) {
            e.preventDefault();
            const form = e.target;
            const selectKelas = document.getElementById('jadwal-kelas');
            const data = {
                hari: document.getElementById('jadwal-hari').value,
                jamMulai: document.getElementById('jadwal-mulai').value,
                jamSelesai: document.getElementById('jadwal-selesai').value,
                kelasId: selectKelas.value,
                namaKelas: selectKelas.options[selectKelas.selectedIndex].text
            };
            if (!data.hari || !data.jamMulai || !data.jamSelesai || !data.kelasId) {
                showNotification("Semua field jadwal harus diisi.");
                return;
            }
            try {
                await addDoc(collection(db, getPrivateCollectionPath('jadwal')), data);
                showNotification("Jadwal berhasil ditambahkan.");
                form.reset();
            } catch (error) {
                console.error("Error tambah jadwal:", error);
                showNotification("Gagal menambah jadwal.");
            }
        }

        async function handleHapusJadwal(jadwalId) {
            showConfirmation("Yakin ingin menghapus jadwal ini?", async () => {
                try {
                    await deleteDoc(doc(db, getPrivateCollectionPath('jadwal'), jadwalId));
                    showNotification("Jadwal berhasil dihapus.");
                } catch (error) {
                    console.error("Error hapus jadwal:", error);
                    showNotification("Gagal menghapus jadwal.");
                }
            });
        }


        // === BAGIAN 4: ABSENSI SISWA === (Tidak berubah)
        async function handleTampilkanAbsensi() {
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;
            if (!kelasId || !tanggal) {
                showNotification("Pilih kelas dan tanggal terlebih dahulu.");
                return;
            }
            const container = document.getElementById('daftar-absensi');
            container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Memuat siswa...</td></tr>';
            try {
                const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
                const qSiswa = query(siswaRef, where("kelasId", "==", kelasId));
                const siswaSnap = await getDocs(qSiswa);
                const absensiRef = collection(db, getPrivateCollectionPath('absensi'));
                const qAbsensi = query(absensiRef, where("kelasId", "==", kelasId), where("tanggal", "==", tanggal));
                const absensiSnap = await getDocs(qAbsensi);
                const absensiData = {};
                absensiSnap.forEach(doc => {
                    const absensi = doc.data();
                    absensiData[absensi.siswaId] = { status: absensi.status, docId: doc.id };
                });
                if (siswaSnap.empty) {
                    container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                    document.getElementById('btn-simpan-absensi-container').classList.add('hidden');
                    return;
                }
                container.innerHTML = '';
                siswaSnap.forEach(docSnap => {
                    const siswa = docSnap.data();
                    const siswaId = docSnap.id;
                    const absensi = absensiData[siswaId];
                    const status = absensi ? absensi.status : 'Hadir';
                    const docId = absensi ? absensi.docId : '';
                    container.innerHTML += `
                        <tr class="siswa-absen-row" data-siswa-id="${siswaId}" data-nama-siswa="${siswa.nama}" data-absen-doc-id="${docId}">
                            <td class="px-6 py-4 whitespace-nowrap">${siswa.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-wrap gap-x-4 gap-y-2">
                                    <label><input type="radio" name="status-${siswaId}" value="Hadir" ${status === 'Hadir' ? 'checked' : ''} class="mr-1"> Hadir</label>
                                    <label><input type="radio" name="status-${siswaId}" value="Izin" ${status === 'Izin' ? 'checked' : ''} class="mr-1"> Izin</label>
                                    <label><input type="radio" name="status-${siswaId}" value="Sakit" ${status === 'Sakit' ? 'checked' : ''} class="mr-1"> Sakit</label>
                                    <label><input type="radio" name="status-${siswaId}" value="Alfa" ${status === 'Alfa' ? 'checked' : ''} class="mr-1"> Alfa</label>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('btn-simpan-absensi-container').classList.remove('hidden');
            } catch (error) {
                console.error("Error tampilkan absensi:", error);
                showNotification("Gagal memuat data absensi.");
            }
        }

        async function handleSimpanAbsensi() {
            const rows = document.querySelectorAll('.siswa-absen-row');
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;
            if (!kelasId || !tanggal) return;
            try {
                const batch = writeBatch(db); 
                for (const row of rows) {
                    const siswaId = row.dataset.siswaId;
                    const namaSiswa = row.dataset.namaSiswa;
                    const docId = row.dataset.absenDocId;
                    const status = row.querySelector(`input[name="status-${siswaId}"]:checked`).value;
                    const data = {
                        siswaId: siswaId,
                        namaSiswa: namaSiswa, 
                        kelasId: kelasId,
                        tanggal: tanggal,
                        status: status
                    };
                    if (docId) {
                        batch.update(doc(db, getPrivateCollectionPath('absensi'), docId), data);
                    } else {
                        const newDocRef = doc(collection(db, getPrivateCollectionPath('absensi')));
                        batch.set(newDocRef, data);
                        row.dataset.absenDocId = newDocRef.id; 
                    }
                }
                await batch.commit();
                showNotification("Data absensi berhasil disimpan!");
            } catch (error) {
                console.error("Error simpan absensi:", error);
                showNotification("Gagal menyimpan absensi.");
            }
        }


        // === BAGIAN 5: INPUT NILAI === (Tidak berubah)
        async function handleTampilkanNilai() {
            const kelasId = document.getElementById('nilai-pilih-kelas').value;
            if (!kelasId) {
                showNotification("Pilih kelas terlebih dahulu.");
                return;
            }
            const container = document.getElementById('daftar-nilai');
            container.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Memuat siswa...</td></tr>';
            try {
                const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
                const qSiswa = query(siswaRef, where("kelasId", "==", kelasId));
                const siswaSnap = await getDocs(qSiswa);
                if (siswaSnap.empty) {
                    container.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                    return;
                }
                container.innerHTML = '';
                for (const docSnap of siswaSnap.docs) {
                    const siswa = docSnap.data();
                    const siswaId = docSnap.id;
                    const nilaiRef = doc(db, getPrivateCollectionPath('nilai'), siswaId);
                    const nilaiSnap = await getDoc(nilaiRef);
                    const nilai = nilaiSnap.exists() ? nilaiSnap.data() : {};
                    container.innerHTML += `
                        <tr class="siswa-nilai-row" data-siswa-id="${siswaId}" data-nama-siswa="${siswa.nama}">
                            <td class="px-6 py-4 whitespace-nowrap">${siswa.nama}</td>
                            <td class="px-6 py-2"><input type="number" class="input-nilai w-20 p-1 border rounded" data-jenis="tugas1" value="${nilai.tugas1 || ''}"></td>
                            <td class="px-6 py-2"><input type="number" class="input-nilai w-20 p-1 border rounded" data-jenis="tugas2" value="${nilai.tugas2 || ''}"></td>
                            <td class="px-6 py-2"><input type="number" class="input-nilai w-20 p-1 border rounded" data-jenis="uts" value="${nilai.uts || ''}"></td>
                            <td class="px-6 py-2"><input type="number" class="input-nilai w-20 p-1 border rounded" data-jenis="uas" value="${nilai.uas || ''}"></td>
                            <td class="px-6 py-2">
                                <button class="btn-simpan-nilai-siswa bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600" data-siswa-id="${siswaId}">Simpan</button>
                            </td>
                        </tr>
                    `;
                }
                document.querySelectorAll('.btn-simpan-nilai-siswa').forEach(btn => {
                    btn.addEventListener('click', (e) => handleSimpanNilaiSiswa(e.target.dataset.siswaId));
                });
            } catch (error) {
                console.error("Error tampilkan nilai:", error);
                showNotification("Gagal memuat data nilai.");
            }
        }

        async function handleSimpanNilaiSiswa(siswaId) {
            const row = document.querySelector(`.siswa-nilai-row[data-siswa-id="${siswaId}"]`);
            if (!row) return;
            const kelasId = document.getElementById('nilai-pilih-kelas').value;
            const namaSiswa = row.dataset.namaSiswa;
            const dataNilai = {
                tugas1: row.querySelector('[data-jenis="tugas1"]').valueAsNumber || 0,
                tugas2: row.querySelector('[data-jenis="tugas2"]').valueAsNumber || 0,
                uts: row.querySelector('[data-jenis="uts"]').valueAsNumber || 0,
                uas: row.querySelector('[data-jenis="uas"]').valueAsNumber || 0,
                siswaId: siswaId,
                namaSiswa: namaSiswa,
                kelasId: kelasId,
                namaKelas: document.getElementById('nilai-pilih-kelas').options[document.getElementById('nilai-pilih-kelas').selectedIndex].text
            };
            try {
                const docRef = doc(db, getPrivateCollectionPath('nilai'), siswaId);
                await setDoc(docRef, dataNilai, { merge: true }); 
                showNotification(`Nilai for ${namaSiswa} berhasil disimpan.`);
            } catch (error) {
                console.error("Error simpan nilai:", error);
                showNotification("Gagal menyimpan nilai.");
            }
        }

        // === BAGIAN 6: PERKEMBANGAN MATERI === (Tidak berubah)
        function loadMateri() {
            const materiRef = collection(db, getPrivateCollectionPath('materi'));
            onSnapshot(materiRef, (snapshot) => {
                const container = document.getElementById('daftar-materi-container');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada riwayat materi.</p>';
                    return;
                }
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const materi = docSnap.data();
                    container.innerHTML += `
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-lg">${materi.topik}</h4>
                                <button class="btn-hapus-materi text-red-500 hover:text-red-700 text-sm" data-id="${docSnap.id}">Hapus</button>
                            </div>
                            <p class="text-sm text-gray-600"><strong>Kelas:</strong> ${materi.namaKelas} | <strong>Tanggal:</strong> ${materi.tanggal}</p>
                            <p class="mt-2 text-gray-700">${materi.catatan}</p>
                        </div>
                    `;
                });
                document.querySelectorAll('.btn-hapus-materi').forEach(btn => {
                    btn.addEventListener('click', (e) => handleHapusMateri(e.target.dataset.id));
                });
            });
        }

        async function handleTambahMateri(e) {
            e.preventDefault();
            const form = e.target;
            const selectKelas = document.getElementById('materi-pilih-kelas');
            const data = {
                kelasId: selectKelas.value,
                namaKelas: selectKelas.options[selectKelas.selectedIndex].text,
                tanggal: document.getElementById('materi-tanggal').value,
                topik: document.getElementById('materi-topik').value.trim(),
                catatan: document.getElementById('materi-catatan').value.trim()
            };
            if (!data.kelasId || !data.tanggal || !data.topik) {
                showNotification("Kelas, tanggal, dan topik harus diisi.");
                return;
            }
            try {
                await addDoc(collection(db, getPrivateCollectionPath('materi')), data);
                showNotification("Catatan materi berhasil disimpan.");
                form.reset();
                setInitialDate();
            } catch (error) {
                console.error("Error tambah materi:", error);
                showNotification("Gagal menyimpan materi.");
            }
        }
        
        async function handleHapusMateri(materiId) {
             showConfirmation("Yakin ingin menghapus catatan materi ini?", async () => {
                try {
                    await deleteDoc(doc(db, getPrivateCollectionPath('materi'), materiId));
                    showNotification("Catatan materi berhasil dihapus.");
                } catch (error) {
                    console.error("Error hapus materi:", error);
                    showNotification("Gagal menghapus materi.");
                }
            });
        }

        // === BARU: BAGIAN 7: BANK SUMBER BELAJAR ===
        
        function loadSumberBelajar() {
            const sumberRef = collection(db, getPrivateCollectionPath('sumber_belajar'));
            onSnapshot(sumberRef, (snapshot) => {
                const container = document.getElementById('daftar-sumber-belajar');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>';
                    return;
                }
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const sumber = docSnap.data();
                    container.innerHTML += `
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-lg">${sumber.judul}</h4>
                                    <span class="text-xs font-medium ${sumber.kelasId === 'semua' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'} px-2 py-0.5 rounded-full">${sumber.namaKelas}</span>
                                    <p class="text-sm text-gray-600 mt-2">${sumber.deskripsi}</p>
                                </div>
                                <button class="btn-hapus-sumber text-red-500 hover:text-red-700 text-sm flex-shrink-0 ml-4" data-id="${docSnap.id}">Hapus</button>
                            </div>
                            <a href="${sumber.link}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 bg-blue-600 text-white px-4 py-1 rounded-lg text-sm font-semibold hover:bg-blue-700">
                                Kunjungi Link
                            </a>
                        </div>
                    `;
                });
                document.querySelectorAll('.btn-hapus-sumber').forEach(btn => {
                    btn.addEventListener('click', (e) => handleHapusSumber(e.target.dataset.id));
                });
            });
        }

        async function handleTambahSumber(e) {
            e.preventDefault();
            const form = e.target;
            const selectKelas = document.getElementById('sumber-belajar-pilih-kelas');
            const data = {
                judul: document.getElementById('sumber-judul').value.trim(),
                link: document.getElementById('sumber-link').value.trim(),
                deskripsi: document.getElementById('sumber-deskripsi').value.trim(),
                kelasId: selectKelas.value,
                namaKelas: selectKelas.options[selectKelas.selectedIndex].text
            };
            if (!data.judul || !data.link) {
                showNotification("Judul dan Link harus diisi.");
                return;
            }
            try {
                await addDoc(collection(db, getPrivateCollectionPath('sumber_belajar')), data);
                showNotification("Sumber belajar berhasil disimpan.");
                form.reset();
            } catch (error) {
                console.error("Error tambah sumber:", error);
                showNotification("Gagal menyimpan sumber belajar.");
            }
        }
        
        async function handleHapusSumber(sumberId) {
             showConfirmation("Yakin ingin menghapus sumber belajar ini?", async () => {
                try {
                    await deleteDoc(doc(db, getPrivateCollectionPath('sumber_belajar'), sumberId));
                    showNotification("Sumber belajar berhasil dihapus.");
                } catch (error) {
                    console.error("Error hapus sumber:", error);
                    showNotification("Gagal menghapus sumber.");
                }
            });
        }

        // === BARU: BAGIAN 8: CATATAN PERKEMBANGAN SISWA ===
        
        // Dipanggil saat tombol "Catatan" diklik
        async function handleLihatCatatan(dataset) {
            const { siswaId, namaSiswa, kelasId, namaKelas } = dataset;
            
            // Isi data ke modal
            document.getElementById('catatan-modal-title').textContent = `Catatan untuk ${namaSiswa}`;
            document.getElementById('catatan-modal-siswaId').value = siswaId;
            document.getElementById('catatan-modal-namaSiswa').value = namaSiswa;
            document.getElementById('catatan-modal-kelasId').value = kelasId;
            document.getElementById('catatan-modal-namaKelas').value = namaKelas;
            
            // Muat catatan
            await loadCatatanSiswa(siswaId);
            
            // Tampilkan modal
            catatanModal.classList.remove('hidden');
        }

        // Memuat riwayat catatan ke dalam modal
        async function loadCatatanSiswa(siswaId) {
            const container = document.getElementById('catatan-modal-list');
            container.innerHTML = '<p class="text-gray-500">Memuat catatan...</p>';
            
            try {
                const catatanRef = collection(db, getPrivateCollectionPath('catatan_siswa'));
                const q = query(catatanRef, where("siswaId", "==", siswaId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada catatan.</p>';
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const catatan = docSnap.data();
                    container.innerHTML += `
                        <div class="border-b pb-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold text-gray-600">${catatan.tanggal}</span>
                                <button class="btn-hapus-catatan text-red-500 hover:text-red-700 text-xs" data-id="${docSnap.id}" data-siswa-id="${siswaId}">Hapus</button>
                            </div>
                            <p class="text-gray-800">${catatan.catatan}</p>
                        </div>
                    `;
                });
                
                // Tambahkan listener ke tombol hapus
                container.querySelectorAll('.btn-hapus-catatan').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        handleHapusCatatan(e.target.dataset.id, e.target.dataset.siswaId);
                    });
                });
                
            } catch (error) {
                console.error("Error muat catatan siswa:", error);
                container.innerHTML = '<p class="text-red-500">Gagal memuat catatan.</p>';
            }
        }

        // Menyimpan catatan baru dari modal
        async function handleTambahCatatan(e) {
            e.preventDefault();
            const input = document.getElementById('catatan-modal-input');
            const catatan = input.value.trim();
            if (!catatan) return;
            
            const siswaId = document.getElementById('catatan-modal-siswaId').value;
            
            const data = {
                catatan: catatan,
                siswaId: siswaId,
                namaSiswa: document.getElementById('catatan-modal-namaSiswa').value,
                kelasId: document.getElementById('catatan-modal-kelasId').value,
                namaKelas: document.getElementById('catatan-modal-namaKelas').value,
                tanggal: new Date().toISOString().split('T')[0]
            };
            
            try {
                await addDoc(collection(db, getPrivateCollectionPath('catatan_siswa')), data);
                input.value = ''; // Kosongkan input
                await loadCatatanSiswa(siswaId); // Muat ulang daftar catatan di modal
            } catch (error) {
                console.error("Error tambah catatan:", error);
                showNotification("Gagal menyimpan catatan.");
            }
        }
        
        // Menghapus satu catatan
        async function handleHapusCatatan(catatanId, siswaId) {
             // Tidak perlu konfirmasi, risiko rendah
            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('catatan_siswa'), catatanId));
                await loadCatatanSiswa(siswaId); // Muat ulang daftar
            } catch (error) {
                console.error("Error hapus catatan:", error);
                showNotification("Gagal menghapus catatan.");
            }
        }


        // === BAGIAN 9: LAPORAN === (Sebelumnya Bagian 7)
        
        async function handleBuatLaporan() {
            const tipe = document.getElementById('laporan-tipe').value;
            const kelasId = document.getElementById('laporan-pilih-kelas').value;
            const outputContainer = document.getElementById('laporan-output');
            outputContainer.innerHTML = '<p class="text-gray-500">Membuat laporan...</p>';
            if (tipe === 'nilai') {
                await buatLaporanNilai(kelasId, outputContainer);
            } else if (tipe === 'absensi') {
                await buatLaporanAbsensi(kelasId, outputContainer);
            }
        }

        async function buatLaporanNilai(kelasId, container) {
            try {
                let q;
                const nilaiRef = collection(db, getPrivateCollectionPath('nilai'));
                if (kelasId) {
                    q = query(nilaiRef, where("kelasId", "==", kelasId));
                } else {
                    q = query(nilaif); 
                }
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada data nilai untuk laporan ini.</p>';
                    return;
                }
                let tableHtml = `<h3 class="text-xl font-semibold mb-4">Laporan Nilai</h3>
                    <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Tugas 1</th>
                                <th class="px-4 py-2 text-left">Tugas 2</th>
                                <th class="px-4 py-2 text-left">UTS</th>
                                <th class="px-4 py-2 text-left">UAS</th>
                                <th class="px-4 py-2 text-left">Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>`;
                snapshot.forEach(docSnap => {
                    const nilai = docSnap.data();
                    const avg = ((nilai.tugas1 || 0) + (nilai.tugas2 || 0) + (nilai.uts || 0) + (nilai.uas || 0)) / 4;
                    tableHtml += `
                        <tr>
                            <td class="px-4 py-2">${nilai.namaSiswa}</td>
                            <td class="px-4 py-2">${nilai.namaKelas}</td>
                            <td class="px-4 py-2">${nilai.tugas1 || 0}</td>
                            <td class="px-4 py-2">${nilai.tugas2 || 0}</td>
                            <td class="px-4 py-2">${nilai.uts || 0}</td>
                            <td class="px-4 py-2">${nilai.uas || 0}</td>
                            <td class="px-4 py-2 font-semibold">${avg.toFixed(2)}</td>
                        </tr>
                    `;
                });
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error buat laporan nilai:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan nilai.</p>';
            }
        }

        async function buatLaporanAbsensi(kelasId, container) {
            try {
                let q;
                const absensiRef = collection(db, getPrivateCollectionPath('absensi'));
                if (kelasId) {
                    q = query(absensiRef, where("kelasId", "==", kelasId));
                } else {
                    q = query(absensiRef); 
                }
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada data absensi untuk laporan ini.</p>';
                    return;
                }
                const rekap = {};
                snapshot.forEach(docSnap => {
                    const absensi = docSnap.data();
                    const id = absensi.siswaId;
                    if (!rekap[id]) {
                        rekap[id] = { 
                            nama: absensi.namaSiswa, 
                            kelas: absensi.namaKelas, 
                            Hadir: 0, 
                            Izin: 0, 
                            Sakit: 0, 
                            Alfa: 0 
                        };
                    }
                    if (rekap[id][absensi.status] !== undefined) {
                        rekap[id][absensi.status]++;
                    }
                });
                let tableHtml = `<h3 class="text-xl font-semibold mb-4">Rekapitulasi Absensi</h3>
                    <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Hadir</th>
                                <th class="px-4 py-2 text-left">Izin</th>
                                <th class="px-4 py-2 text-left">Sakit</th>
                                <th class="px-4 py-2 text-left">Alfa</th>
                            </tr>
                        </thead>
                        <tbody>`;
                for (const siswaId in rekap) {
                    const data = rekap[siswaId];
                    tableHtml += `
                        <tr>
                            <td class="px-4 py-2">${data.nama}</td>
                            <td class="px-4 py-2">${data.kelas}</td>
                            <td class="px-4 py-2">${data.Hadir}</td>
                            <td class="px-4 py-2">${data.Izin}</td>
                            <td class="px-4 py-2">${data.Sakit}</td>
                            <td class="px-4 py-2">${data.Alfa}</td>
                        </tr>
                    `;
                }
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error buat laporan absensi:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan absensi.</p>';
            }
        }

    </script>
</body>
</html>


