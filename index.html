<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sembunyikan page-content secara default */
        .page-content {
            display: none;
        }
        /* Tampilkan page-content yang aktif */
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-container" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="p-8 bg-white rounded-lg shadow-xl text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Login Guru</h1>
            <p class="text-gray-600 mb-8">Silakan login menggunakan akun Google Anda yang terdaftar.</p>
            <button id="btn-login-google" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 flex items-center justify-center space-x-2">
                <ion-icon name="logo-google" class="text-xl"></ion-icon>
                <span>Login dengan Google</span>
            </button>
        </div>
    </div>

    <div id="dashboard-container" class="flex flex-col md:flex-row min-h-screen hidden">
        <aside class="w-full md:w-64 bg-white shadow-lg md:min-h-screen p-4">
            <h1 class="text-2xl font-bold text-blue-700 mb-6 text-center">Dashboard Guru</h1>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 bg-blue-100" data-page="dashboard">
                            <ion-icon name="home-outline" class="mr-3 text-xl"></ion-icon>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="kelas-siswa">
                            <ion-icon name="school-outline" class="mr-3 text-xl"></ion-icon>
                            Kelas & Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="jadwal">
                            <ion-icon name="calendar-outline" class="mr-3 text-xl"></ion-icon>
                            Jadwal Mengajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="absensi">
                            <ion-icon name="checkbox-outline" class="mr-3 text-xl"></ion-icon>
                            Absensi Siswa
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="nilai">
                            <ion-icon name="create-outline" class="mr-3 text-xl"></ion-icon>
                            Input Nilai
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="materi">
                            <ion-icon name="book-outline" class="mr-3 text-xl"></ion-icon>
                            Perkembangan Materi
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="sumber-belajar">
                            <ion-icon name="archive-outline" class="mr-3 text-xl"></ion-icon>
                            Bank Sumber Belajar
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100" data-page="laporan">
                            <ion-icon name="document-text-outline" class="mr-3 text-xl"></ion-icon>
                            Laporan
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="mt-8 p-3 bg-gray-50 rounded-lg">
                <span class="text-xs text-gray-500">Login sebagai:</span>
                <span id="userEmailDisplay" class="text-sm font-medium text-gray-800 break-all">Memuat...</span>
            </div>
            <button id="btn-logout" class="mt-4 w-full flex items-center justify-center p-3 rounded-lg text-red-600 bg-red-100 hover:bg-red-200 transition duration-300">
                <ion-icon name="log-out-outline" class="mr-3 text-xl"></ion-icon>
                Logout
            </button>
            </aside>

        <main class="flex-1 p-6 md:p-10">
            <div id="dashboard-page" class="page-content active">
                <h2 class="text-3xl font-bold mb-6">Selamat Datang, Guru!</h2>
                <p class="text-gray-600 mb-6">Gunakan menu di samping untuk mengelola data mengajar Anda. Semua data disimpan secara otomatis dan aman.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Jadwal Hari Ini</h3>
                        <p id="jadwal-hari-ini" class="text-gray-600">Memuat jadwal...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Siswa</h3>
                        <p id="total-siswa" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Total Kelas</h3>
                        <p id="total-kelas" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <div id="kelas-siswa-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Manajemen Kelas & Siswa</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Kelas Baru</h3>
                            <form id="form-tambah-kelas" class="flex items-center space-x-3">
                                <input type="text" id="input-nama-kelas" placeholder="Cth: 10-A IPA" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                    Tambah
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Daftar Kelas</h3>
                            <div id="daftar-kelas-list" class="space-y-3">
                                <p class="text-gray-500">Belum ada data kelas.</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tambah Siswa Baru (Manual)</h3>
                            <form id="form-tambah-siswa" class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Siswa</label>
                                    <input type="text" id="input-nama-siswa" placeholder="Cth: Budi Santoso" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                    <select id="select-kelas-siswa" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih Kelas...</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                        Tambah Siswa
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Import Siswa dari CSV</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pilih File CSV</label>
                                    <input type="file" id="import-csv-file" accept=".csv" class="mt-1 w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100">
                                </div>
                                <p class="text-xs text-gray-500">Format CSV: Kolom pertama <b class="font-medium">Nama Siswa</b>, Kolom kedua <b class="font-medium">Nama Kelas</b> (harus sama persis dengan nama kelas yang sudah ada).</p>
                                <button id="btn-import-csv" class="w-full bg-green-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                                    Mulai Import
                                </button>
                            </div>
                        </div>
                        </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Siswa per Kelas</h3>
                    <div id="daftar-siswa-container" class="space-y-4">
                        <p class="text-gray-500">Belum ada data siswa.</p>
                    </div>
                </div>
            </div>

            <div id="jadwal-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Jadwal Mengajar</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Jadwal Baru</h3>
                    <form id="form-tambah-jadwal" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <select id="jadwal-hari" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Hari</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                        </select>
                        <input type="time" id="jadwal-mulai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="time" id="jadwal-selesai" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <select id="jadwal-kelas" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Kelas</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                            Tambah
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-jadwal" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="absensi-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Absensi Siswa</h2>
                
                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="absensi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tanggal</label>
                        <input type="date" id="absensi-pilih-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="btn-tampilkan-absensi" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-absensi" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Pilih kelas dan tanggal terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                    <div id="btn-simpan-absensi-container" class="p-4 text-right hidden">
                        <button id="btn-simpan-absensi" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                            Simpan Absensi
                        </button>
                    </div>
                </div>
            </div>

            <div id="nilai-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Input Nilai Siswa</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="nilai-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <button id="btn-tampilkan-nilai" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Tampilkan
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 1</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 2</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 3</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 4</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 5</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 6</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 7</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 8</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 9</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tugas 10</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UTS 1</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UTS 2</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UAS 1</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UAS 2</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-nilai" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Pilih kelas terlebih dahulu.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="materi-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Perkembangan Materi</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Catat Materi yang Diajarkan</h3>
                    <form id="form-tambah-materi" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                                <select id="materi-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" id="materi-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Topik / Bab</label>
                            <input type="text" id="materi-topik" placeholder="Cth: Bab 1 - Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Catatan</label>
                            <textarea id="materi-catatan" rows="3" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Catatan singkat..."></textarea>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Materi
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Riwayat Materi</h3>
                    <div id="daftar-materi-container" class="space-y-4">
                        <p class="text-gray-500">Belum ada riwayat materi.</p>
                    </div>
                </div>
            </div>

            <div id="sumber-belajar-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Bank Sumber Belajar</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Sumber Belajar Baru</h3>
                    <form id="form-tambah-sumber" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Judul</label>
                            <input type="text" id="sumber-judul" placeholder="Cth: Video Penjelasan Aljabar" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Link (URL)</label>
                            <input type="url" id="sumber-link" placeholder="https://youtube.com/watch?v=..." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Deskripsi</label>
                            <textarea id="sumber-deskripsi" rows="2" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Video tentang..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Untuk Kelas (Opsional)</label>
                            <select id="sumber-belajar-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="semua">Semua Kelas</option>
                                </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Simpan Sumber
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Materi Tersimpan</h3>
                    <div id="daftar-sumber-belajar" class="space-y-4">
                        <p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>
                    </div>
                </div>
            </div>

            <div id="laporan-page" class="page-content">
                <h2 class="text-3xl font-bold mb-6">Laporan</h2>

                <div class="bg-white p-6 rounded-lg shadow mb-6 flex items-end space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Tipe Laporan</label>
                        <select id="laporan-tipe" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="nilai">Laporan Nilai</option>
                            <option value="absensi">Laporan Absensi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="laporan-pilih-kelas" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <button id="btn-buat-laporan" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Buat Laporan
                    </button>
                </div>

                <div id="laporan-output" class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-500">Pilih tipe laporan dan kelas untuk melihat hasil.</p>
                </div>

            </div>

        </main>
    </div> <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 md:w-1/3">
            <p id="notification-message" class="text-lg font-medium"></p>
            <button id="notification-close" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                Tutup
            </button>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
            <h3 class="text-xl font-bold mb-4">Konfirmasi Hapus</h3>
            <p id="confirmation-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold hover:bg-gray-400">
                    Batal
                </button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-red-700">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
    <div id="catatan-siswa-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/5 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="catatan-modal-title" class="text-xl font-bold">Catatan Perkembangan</h3>
                <button id="catatan-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">Ã—</button>
            </div>
            
            <form id="form-tambah-catatan" class="mb-4 space-y-2">
                <label for="catatan-modal-input" class="block text-sm font-medium text-gray-700">Tambah Catatan Baru:</label>
                <textarea id="catatan-modal-input" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis catatan kualitatif..." required></textarea>
                <input type="hidden" id="catatan-modal-siswaId">
                <input type="hidden" id="catatan-modal-namaSiswa">
                <input type="hidden" id="catatan-modal-kelasId">
                <input type="hidden" id="catatan-modal-namaKelas">
                <button type="submit" class="w-full bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700">
                    Simpan Catatan
                </button>
            </form>
            
            <hr class="my-4">
            <h4 class="text-lg font-semibold mb-3">Riwayat Catatan</h4>
            <div id="catatan-modal-list" class="space-y-3 max-h-64 overflow-y-auto">
                <p class="text-gray-500">Belum ada catatan.</p>
            </div>
        </div>
    </div>
    <div id="connection-toast" class="fixed bottom-0 left-1/2 -translate-x-1/2 mb-5 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-20 opacity-0 hidden">
        <span id="connection-toast-message" class="font-medium"></span>
    </div>


    <script type="module">
        // Impor fungsi-fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch,
            serverTimestamp, // BARU: Untuk createdAt
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === KONFIGURASI DAN INISIALISASI FIREBASE ===
        
        // --- KONFIGURASI FIREBASE ANDA ---
        // (Pastikan ini adalah config Anda yang valid)
        const firebaseConfig = {
          apiKey: "AIzaSyCa7cNRlEvGfckYDwXppsI0TTxEnP4fIUc",
          authDomain: "sistem-manajemen-guru.firebaseapp.com",
          projectId: "sistem-manajemen-guru",
          storageBucket: "sistem-manajemen-guru.appspot.com",
          messagingSenderId: "527771743263",
          appId: "1:527771743263:web:e8e245cccba74f1041912a"
        };
        // --- AKHIR DARI KONFIGURASI ANDA ---

        let app, auth, db, userId;
        // BARU: Tambahkan provider Google
        const googleProvider = new GoogleAuthProvider();

        let allKelasData = new Map(); // Simpan data kelas di sini

        // setLogLevel('Debug'); // Hapus komentar untuk debugging

        function getPrivateCollectionPath(collectionName) {
            if (!userId) throw new Error("User ID belum siap.");
            return `users/${userId}/${collectionName}`;
        }

        // === Toast Notifikasi === (Tidak berubah)
        const toastElement = document.getElementById('connection-toast');
        const toastMessage = document.getElementById('connection-toast-message');

        function showConnectionToast(message, isError = false) {
            toastMessage.textContent = message;
            toastElement.classList.remove('bg-green-600', 'bg-red-600', 'text-white');
            if (isError) {
                toastElement.classList.add('bg-red-600', 'text-white');
            } else {
                toastElement.classList.add('bg-green-600', 'text-white');
            }
            toastElement.classList.remove('hidden', 'opacity-0', 'translate-y-20');
            setTimeout(() => {
                toastElement.classList.add('opacity-0', 'translate-y-20');
                setTimeout(() => {
                    toastElement.classList.add('hidden');
                }, 300); 
            }, 3000); 
        }

        // === MANAJEMEN MODAL (NOTIFIKASI & KONFIRMASI) === (Tidak berubah)
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }
        notificationClose.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let onConfirmCallback = null;

        function showConfirmation(message, onConfirm) {
            confirmationMessage.textContent = message;
            onConfirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        
        confirmNoBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        });

        confirmYesBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        });

        const catatanModal = document.getElementById('catatan-siswa-modal');
        const catatanModalClose = document.getElementById('catatan-modal-close');
        catatanModalClose.addEventListener('click', () => {
            catatanModal.classList.add('hidden');
        });

        // === MANAJEMEN AUTENTIKASI DAN STATE ===
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setupAuthListener(); // Panggil listener auth
                setupNavigation();
                setupFormListeners();
                setInitialDate();

                // BARU: Tambahkan listener untuk tombol login & logout
                document.getElementById('btn-login-google').addEventListener('click', loginGoogle);
                document.getElementById('btn-logout').addEventListener('click', logout);

            } catch (e) {
                console.error("Error inisialisasi Firebase:", e);
                showConnectionToast("Gagal inisialisasi Firebase. Periksa config.", true);
            }
        });

        // BARU: Fungsi Login Google
        async function loginGoogle() {
            try {
                await signInWithPopup(auth, googleProvider);
                // onAuthStateChanged akan menangani sisanya
            } catch (error) {
                console.error("Gagal login Google:", error);
                showNotification("Gagal login: " + error.message);
            }
        }

        // BARU: Fungsi Logout
        async function logout() {
            try {
                await signOut(auth);
                // onAuthStateChanged akan menangani sisanya
            } catch (error) {
                console.error("Gagal logout:", error);
                showNotification("Gagal logout: " + error.message);
            }
        }

        // MODIFIKASI: Setup Auth Listener
        function setupAuthListener() {
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            const userEmailDisplay = document.getElementById('userEmailDisplay');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User berhasil login
                    userId = user.uid;
                    userEmailDisplay.textContent = user.email || "User"; // Tampilkan email
                    
                    loginContainer.classList.add('hidden'); // Sembunyikan login
                    dashboardContainer.classList.remove('hidden'); // Tampilkan dashboard

                    if (!window.firebaseConnected) {
                        showConnectionToast("Berhasil login.", false);
                        window.firebaseConnected = true;
                    }
                    await loadAllInitialData(); // Muat data setelah login berhasil

                } else {
                    // User logout
                    userId = null;
                    loginContainer.classList.remove('hidden'); // Tampilkan login
                    dashboardContainer.classList.add('hidden'); // Sembunyikan dashboard
                    window.firebaseConnected = false;
                    
                    // TODO: Hapus data sensitif dari UI jika perlu
                    document.getElementById('daftar-kelas-list').innerHTML = '<p class="text-gray-500">Silakan login...</p>';
                    document.getElementById('daftar-siswa-container').innerHTML = '<p class="text-gray-500">Silakan login...</p>';
                }
            });
        }
        
        async function loadAllInitialData() {
            if (!userId) return;
            loadKelas();
            loadSiswa();
            loadJadwal();
            loadMateri();
            loadDashboardStats();
            loadSumberBelajar();
        }

        // === LOGIKA NAVIGASI === (Tidak berubah)
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page') + '-page';
                    pages.forEach(page => page.classList.remove('active'));
                    navLinks.forEach(nav => nav.classList.remove('bg-blue-100'));
                    const activePage = document.getElementById(pageId);
                    if(activePage) {
                        activePage.classList.add('active');
                    }
                    link.classList.add('bg-blue-100');
                    if (pageId === 'dashboard-page') {
                        loadDashboardStats();
                    }
                });
            });
        }

        function setInitialDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('absensi-pilih-tanggal').value = today;
            document.getElementById('materi-tanggal').value = today;
        }

        // === LISTENER UNTUK SEMUA FORM ===
        function setupFormListeners() {
            document.getElementById('form-tambah-kelas').addEventListener('submit', handleTambahKelas);
            document.getElementById('form-tambah-siswa').addEventListener('submit', handleTambahSiswa);
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-materi').addEventListener('submit', handleTambahMateri);
            document.getElementById('btn-tampilkan-absensi').addEventListener('click', handleTampilkanAbsensi);
            document.getElementById('btn-tampilkan-nilai').addEventListener('click', handleTampilkanNilai);
            document.getElementById('btn-buat-laporan').addEventListener('click', handleBuatLaporan);
            document.getElementById('btn-simpan-absensi').addEventListener('click', handleSimpanAbsensi);
            document.getElementById('form-tambah-sumber').addEventListener('submit', handleTambahSumber);
            document.getElementById('form-tambah-catatan').addEventListener('submit', handleTambahCatatan);

            // BARU: Listener untuk tombol import
            document.getElementById('btn-import-csv').addEventListener('click', handleImportSiswa);
        }

        // === BAGIAN 1: DASHBOARD === (Tidak berubah)
        async function loadDashboardStats() {
            if (!userId) return;
            const kelasRef = collection(db, getPrivateCollectionPath('kelas'));
            onSnapshot(kelasRef, (snapshot) => {
                document.getElementById('total-kelas').textContent = snapshot.size;
            });
            const siswaRef = collection(db, getPrivateCollectionPath('siswa'));
            onSnapshot(siswaRef, (snapshot) => {
                document.getElementById('total-siswa').textContent = snapshot.size;
            });
            const hariIni = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"][new Date().getDay()];
            const jadwalRef = collection(db, getPrivateCollectionPath('jadwal'));
            const q = query(jadwalRef, where("hari", "==", hariIni));
            const querySnapshot = await getDocs(q);
            const jadwalList = [];
            querySnapshot.forEach((doc) => {
                jadwalList.push(doc.data());
            });
            if (jadwalList.length > 0) {
                document.getElementById('jadwal-hari-ini').innerHTML = jadwalList
                    .map(j => `<span class="block">${j.namaKelas} (${j.mulai} - ${j.selesai})</span>`)
                    .join('');
            } else {
                document.getElementById('jadwal-hari-ini').textContent = "Tidak ada jadwal mengajar hari ini.";
            }
        }

        // === BAGIAN 2: KELAS & SISWA ===
        // MODIFIKASI: loadKelas sekarang menyimpan data ke map global
        function loadKelas() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('kelas')));
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('daftar-kelas-list');
                const selectDropdowns = document.querySelectorAll('#select-kelas-siswa, #jadwal-kelas, #absensi-pilih-kelas, #nilai-pilih-kelas, #materi-pilih-kelas, #laporan-pilih-kelas, #sumber-belajar-pilih-kelas');
                
                allKelasData.clear(); // BARU: Bersihkan map
                listContainer.innerHTML = '';
                
                selectDropdowns.forEach(select => {
                    // Simpan opsi pertama (placeholder)
                    const firstOption = select.options[0] ? select.options[0].outerHTML : '<option value="">Pilih Kelas</option>';
                    select.innerHTML = firstOption;
                });

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">Belum ada data kelas.</p>';
                    return;
                }

                snapshot.docs.sort((a, b) => a.data().nama.localeCompare(b.data().nama)).forEach(doc => {
                    const kelas = doc.data();
                    const kelasId = doc.id;
                    allKelasData.set(kelas.nama, kelasId); // BARU: Isi map (Nama Kelas -> ID Kelas)

                    // Tambahkan ke Daftar Kelas
                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium">${kelas.nama}</span>
                            <button data-id="${kelasId}" data-nama="${kelas.nama}" class="btn-hapus-kelas text-red-500 hover:text-red-700">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    `;

                    // Tambahkan ke semua dropdown
                    selectDropdowns.forEach(select => {
                        select.innerHTML += `<option value="${kelasId}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

                // Tambahkan listener hapus
                document.querySelectorAll('.btn-hapus-kelas').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        const nama = button.dataset.nama;
                        showConfirmation(`Yakin ingin menghapus kelas "${nama}"? Ini akan menghapus semua data terkait (siswa, jadwal, absensi, nilai) kelas ini.`, () => {
                            handleHapusKelas(id, nama);
                        });
                    });
                });
            });
        }
        
        async function handleTambahKelas(e) {
            e.preventDefault();
            const input = document.getElementById('input-nama-kelas');
            const namaKelas = input.value.trim();
            if (!namaKelas || !userId) return;

            try {
                await addDoc(collection(db, getPrivateCollectionPath('kelas')), {
                    nama: namaKelas,
                    createdAt: serverTimestamp()
                });
                input.value = '';
                showNotification(`Kelas "${namaKelas}" berhasil ditambahkan.`);
            } catch (error) {
                console.error("Error tambah kelas:", error);
                showNotification("Gagal menambahkan kelas.", true);
            }
        }

        async function handleHapusKelas(kelasId, namaKelas) {
            if (!userId || !kelasId) return;
            try {
                // Ini adalah operasi yang kompleks. Idealnya ditangani oleh backend (Cloud Function)
                // Untuk frontend, kita hapus satu per satu (bisa lambat/tidak lengkap jika koneksi putus)
                const batch = writeBatch(db);

                // 1. Hapus kelas
                batch.delete(doc(db, getPrivateCollectionPath('kelas'), kelasId));

                // 2. Hapus siswa di kelas tsb
                const siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
                const siswaDocs = await getDocs(siswaQuery);
                siswaDocs.forEach(doc => batch.delete(doc.ref));

                // 3. Hapus jadwal di kelas tsb
                const jadwalQuery = query(collection(db, getPrivateCollectionPath('jadwal')), where("kelasId", "==", kelasId));
                const jadwalDocs = await getDocs(jadwalQuery);
                jadwalDocs.forEach(doc => batch.delete(doc.ref));

                // (Lanjutkan untuk absensi, nilai, materi, catatan jika diperlukan...)

                await batch.commit();
                showNotification(`Kelas "${namaKelas}" dan data siswanya berhasil dihapus.`);
            } catch (error) {
                console.error("Error hapus kelas:", error);
                showNotification("Gagal menghapus kelas.", true);
            }
        }

        function loadSiswa() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('siswa')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-siswa-container');
                container.innerHTML = '';
                
                const siswaByKelas = {};
                snapshot.forEach(doc => {
                    const siswa = doc.data();
                    siswa.id = doc.id;
                    if (!siswaByKelas[siswa.kelasId]) {
                        siswaByKelas[siswa.kelasId] = [];
                    }
                    siswaByKelas[siswa.kelasId].push(siswa);
                });

                if (Object.keys(siswaByKelas).length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada data siswa.</p>';
                    return;
                }

                for (const kelasId in siswaByKelas) {
                    const namaKelas = siswaByKelas[kelasId][0]?.namaKelas || "Kelas (ID: " + kelasId + ")";
                    
                    // Urutkan siswa berdasarkan nama
                    siswaByKelas[kelasId].sort((a, b) => a.nama.localeCompare(b.nama));
                    
                    const siswaListHtml = siswaByKelas[kelasId].map(siswa => `
                        <li class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 rounded">
                            <span>${siswa.nama}</span>
                            <div class="space-x-2">
                                <button data-id="${siswa.id}" data-nama="${siswa.nama}" data-kelasid="${siswa.kelasId}" data-namakelas="${namaKelas}" class="btn-catatan-siswa text-blue-500 hover:text-blue-700">
                                    <ion-icon name="clipboard-outline"></ion-icon>
                                </button>
                                <button data-id="${siswa.id}" data-nama="${siswa.nama}" class="btn-hapus-siswa text-red-500 hover:text-red-700">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </div>
                        </li>
                    `).join('');

                    container.innerHTML += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-lg mb-2">${namaKelas}</h4>
                            <ul class="divide-y divide-gray-200">${siswaListHtml}</ul>
                        </div>
                    `;
                }

                // Listener Hapus Siswa
                document.querySelectorAll('.btn-hapus-siswa').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        const nama = button.dataset.nama;
                        showConfirmation(`Yakin ingin menghapus siswa "${nama}"?`, async () => {
                            try {
                                await deleteDoc(doc(db, getPrivateCollectionPath('siswa'), id));
                                showNotification(`Siswa "${nama}" berhasil dihapus.`);
                            } catch (error) {
                                console.error("Error hapus siswa:", error);
                                showNotification("Gagal menghapus siswa.", true);
                            }
                        });
                    });
                });
                
                // Listener Catatan Siswa
                document.querySelectorAll('.btn-catatan-siswa').forEach(button => {
                    button.addEventListener('click', () => {
                        document.getElementById('catatan-modal-siswaId').value = button.dataset.id;
                        document.getElementById('catatan-modal-namaSiswa').value = button.dataset.nama;
                        document.getElementById('catatan-modal-kelasId').value = button.dataset.kelasid;
                        document.getElementById('catatan-modal-namaKelas').value = button.dataset.namakelas;
                        document.getElementById('catatan-modal-title').textContent = `Catatan untuk ${button.dataset.nama}`;
                        loadCatatanSiswa(button.dataset.id);
                        catatanModal.classList.remove('hidden');
                    });
                });
            });
        }
        
        async function handleTambahSiswa(e) {
            e.preventDefault();
            const namaSiswa = document.getElementById('input-nama-siswa').value.trim();
            const selectKelas = document.getElementById('select-kelas-siswa');
            const kelasId = selectKelas.value;
            const namaKelas = selectKelas.options[selectKelas.selectedIndex].text;

            if (!namaSiswa || !kelasId || !userId) {
                showNotification("Nama siswa dan kelas harus diisi.", true);
                return;
            }

            try {
                await addDoc(collection(db, getPrivateCollectionPath('siswa')), {
                    nama: namaSiswa,
                    kelasId: kelasId,
                    namaKelas: namaKelas,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-tambah-siswa').reset();
                showNotification(`Siswa "${namaSiswa}" berhasil ditambahkan ke kelas ${namaKelas}.`);
            } catch (error) {
                console.error("Error tambah siswa:", error);
                showNotification("Gagal menambahkan siswa.", true);
            }
        }

        // BARU: Fungsi untuk Import Siswa
        async function handleImportSiswa() {
            const fileInput = document.getElementById('import-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                showNotification("Silakan pilih file CSV terlebih dahulu.", true);
                return;
            }
            
            if (!userId) {
                showNotification("Anda harus login untuk import data.", true);
                return;
            }

            // Periksa map kelas
            if (allKelasData.size === 0) {
                showNotification("Data kelas belum dimuat atau masih kosong. Tambahkan kelas terlebih dahulu.", true);
                return;
            }
            
            showConnectionToast("Mulai mengimpor, mohon tunggu...");

            Papa.parse(file, {
                skipEmptyLines: true,
                complete: async (results) => {
                    const data = results.data;
                    if (data.length === 0) {
                        showNotification("File CSV kosong.", true);
                        return;
                    }

                    const batch = writeBatch(db);
                    let berhasilCount = 0;
                    let gagalCount = 0;
                    const gagalList = [];

                    for (const row of data) {
                        const namaSiswa = row[0] ? row[0].trim() : '';
                        const namaKelas = row[1] ? row[1].trim() : '';

                        if (!namaSiswa || !namaKelas) {
                            gagalCount++;
                            gagalList.push(`${namaSiswa || '(Nama Kosong)'} - ${namaKelas || '(Kelas Kosong)'}: Data tidak lengkap`);
                            continue;
                        }
                        
                        // Cari ID kelas dari nama kelas menggunakan map
                        const kelasId = allKelasData.get(namaKelas);

                        if (kelasId) {
                            // Kelas ditemukan, tambahkan siswa ke batch
                            const siswaRef = doc(collection(db, getPrivateCollectionPath('siswa')));
                            batch.set(siswaRef, {
                                nama: namaSiswa,
                                kelasId: kelasId,
                                namaKelas: namaKelas,
                                createdAt: serverTimestamp()
                            });
                            berhasilCount++;
                        } else {
                            // Kelas tidak ditemukan
                            gagalCount++;
                            gagalList.push(`${namaSiswa} - ${namaKelas}: Nama kelas tidak ditemukan`);
                        }
                    }

                    try {
                        await batch.commit();
                        let message = `${berhasilCount} siswa berhasil diimpor.`;
                        if (gagalCount > 0) {
                            message += `\n${gagalCount} siswa gagal diimpor.`;
                            console.warn("Gagal import:", gagalList);
                            // Tampilkan detail kegagalan jika perlu
                            // message += `\nDetail Gagal:\n${gagalList.slice(0, 5).join('\n')}...`;
                        }
                        showNotification(message);
                    } catch (error) {
                        console.error("Error commit batch import:", error);
                        showNotification("Terjadi kesalahan besar saat menyimpan data import.", true);
                    } finally {
                        fileInput.value = ''; // Reset input file
                    }
                },
                error: (err) => {
                    console.error("Error parsing CSV:", err);
                    showNotification("Gagal membaca file CSV. Pastikan formatnya benar.", true);
                }
            });
        }
        // AKHIR BARU

        // === BAGIAN 3: JADWAL === (Tidak berubah)
        function loadJadwal() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('jadwal')));
            const hariOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('daftar-jadwal');
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada jadwal.</td></tr>';
                    return;
                }

                const jadwalList = [];
                snapshot.forEach(doc => {
                    jadwalList.push({ id: doc.id, ...doc.data() });
                });

                // Urutkan berdasarkan hari, lalu jam mulai
                jadwalList.sort((a, b) => {
                    const hariIndexA = hariOrder.indexOf(a.hari);
                    const hariIndexB = hariOrder.indexOf(b.hari);
                    if (hariIndexA !== hariIndexB) {
                        return hariIndexA - hariIndexB;
                    }
                    return a.mulai.localeCompare(b.mulai);
                });

                jadwalList.forEach(jadwal => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.hari}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.mulai} - ${jadwal.selesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${jadwal.namaKelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button data-id="${jadwal.id}" class="btn-hapus-jadwal text-red-500 hover:text-red-700">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                document.querySelectorAll('.btn-hapus-jadwal').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation("Yakin ingin menghapus jadwal ini?", async () => {
                            try {
                                await deleteDoc(doc(db, getPrivateCollectionPath('jadwal'), id));
                                showNotification("Jadwal berhasil dihapus.");
                            } catch (error) {
                                console.error("Error hapus jadwal:", error);
                                showNotification("Gagal menghapus jadwal.", true);
                            }
                        });
                    });
                });
            });
        }
        
        async function handleTambahJadwal(e) {
            e.preventDefault();
            const hari = document.getElementById('jadwal-hari').value;
            const mulai = document.getElementById('jadwal-mulai').value;
            const selesai = document.getElementById('jadwal-selesai').value;
            const selectKelas = document.getElementById('jadwal-kelas');
            const kelasId = selectKelas.value;
            const namaKelas = selectKelas.options[selectKelas.selectedIndex].text;

            if (!hari || !mulai || !selesai || !kelasId || !userId) {
                showNotification("Semua field jadwal harus diisi.", true);
                return;
            }

            try {
                await addDoc(collection(db, getPrivateCollectionPath('jadwal')), {
                    hari,
                    mulai,
                    selesai,
                    kelasId,
                    namaKelas,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-tambah-jadwal').reset();
                showNotification("Jadwal berhasil ditambahkan.");
            } catch (error) {
                console.error("Error tambah jadwal:", error);
                showNotification("Gagal menambahkan jadwal.", true);
            }
        }

        // === BAGIAN 4: ABSENSI === (Tidak berubah)
        let currentSiswaAbsensi = []; // Simpan daftar siswa untuk disimpan
        
        async function handleTampilkanAbsensi() {
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;

            if (!kelasId || !tanggal || !userId) {
                showNotification("Kelas dan Tanggal harus dipilih.", true);
                return;
            }

            const tbody = document.getElementById('daftar-absensi');
            tbody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Memuat data siswa...</td></tr>';
            currentSiswaAbsensi = []; // Reset

            // 1. Dapatkan data absensi yang SUDAH ADA (jika ada)
            const absensiDocId = `${tanggal}_${kelasId}`;
            const absensiRef = doc(db, getPrivateCollectionPath('absensi'), absensiDocId);
            const absensiSnap = await getDoc(absensiRef);
            const statusTersimpan = absensiSnap.exists() ? absensiSnap.data().status : {};

            // 2. Dapatkan daftar siswa di kelas itu
            const siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
            const siswaSnap = await getDocs(siswaQuery);

            if (siswaSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                document.getElementById('btn-simpan-absensi-container').classList.add('hidden');
                return;
            }

            let tableHtml = '';
            
            // Urutkan siswa berdasarkan nama
            const siswaList = [];
            siswaSnap.forEach(doc => siswaList.push({ id: doc.id, ...doc.data() }));
            siswaList.sort((a, b) => a.nama.localeCompare(b.nama));

            siswaList.forEach(siswa => {
                const siswaId = siswa.id;
                const namaSiswa = siswa.nama;
                const status = statusTersimpan[siswaId] || 'H'; // Default 'Hadir'

                currentSiswaAbsensi.push({ id: siswaId, nama: namaSiswa }); // Tambahkan ke daftar

                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">${namaSiswa}</td>
                        <td class="px-6 py-4">
                            <select data-siswa-id="${siswaId}" class="status-absensi w-full max-w-xs px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="H" ${status === 'H' ? 'selected' : ''}>Hadir</option>
                                <option value="I" ${status === 'I' ? 'selected' : ''}>Izin</option>
                                <option value="S" ${status === 'S' ? 'selected' : ''}>Sakit</option>
                                <option value="A" ${status === 'A' ? 'selected' : ''}>Alfa</option>
                            </select>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = tableHtml;
            document.getElementById('btn-simpan-absensi-container').classList.remove('hidden');
        }

        async function handleSimpanAbsensi() {
            const kelasId = document.getElementById('absensi-pilih-kelas').value;
            const namaKelas = document.getElementById('absensi-pilih-kelas').options[document.getElementById('absensi-pilih-kelas').selectedIndex].text;
            const tanggal = document.getElementById('absensi-pilih-tanggal').value;

            if (!kelasId || !tanggal || !userId || currentSiswaAbsensi.length === 0) {
                showNotification("Gagal menyimpan: Data tidak lengkap.", true);
                return;
            }

            const statusAbsensi = {};
            document.querySelectorAll('.status-absensi').forEach(select => {
                const siswaId = select.dataset.siswaId;
                statusAbsensi[siswaId] = select.value;
            });

            const absensiDocId = `${tanggal}_${kelasId}`;
            const absensiRef = doc(db, getPrivateCollectionPath('absensi'), absensiDocId);

            try {
                await setDoc(absensiRef, {
                    tanggal: tanggal,
                    kelasId: kelasId,
                    namaKelas: namaKelas,
                    status: statusAbsensi,
                    updatedAt: serverTimestamp()
                }, { merge: true }); // Gunakan merge true untuk update jika sudah ada

                showNotification(`Absensi kelas ${namaKelas} tanggal ${tanggal} berhasil disimpan.`);
            } catch (error) {
                console.error("Error simpan absensi:", error);
                showNotification("Gagal menyimpan absensi.", true);
            }
        }

        // === BAGIAN 5: NILAI === (Tidak berubah)
        let currentSiswaNilai = [];
        const TUGAS_COUNT = 10;
        const UTS_COUNT = 2;
        const UAS_COUNT = 2;

        async function handleTampilkanNilai() {
            const kelasId = document.getElementById('nilai-pilih-kelas').value;
            if (!kelasId || !userId) {
                showNotification("Kelas harus dipilih.", true);
                return;
            }

            const tbody = document.getElementById('daftar-nilai');
            tbody.innerHTML = '<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Memuat data nilai...</td></tr>';
            currentSiswaNilai = [];

            // 1. Dapatkan daftar siswa di kelas itu
            const siswaQuery = query(collection(db, getPrivateCollectionPath('siswa')), where("kelasId", "==", kelasId));
            const siswaSnap = await getDocs(siswaQuery);

            if (siswaSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                return;
            }
            
            // Urutkan siswa
            const siswaList = [];
            siswaSnap.forEach(doc => siswaList.push({ id: doc.id, ...doc.data() }));
            siswaList.sort((a, b) => a.nama.localeCompare(b.nama));
            
            // 2. Dapatkan data nilai (jika ada) dalam satu batch
            const nilaiRefs = siswaList.map(siswa => doc(db, getPrivateCollectionPath('nilai'), siswa.id));
            const nilaiDocs = await Promise.all(nilaiRefs.map(ref => getDoc(ref)));
            const nilaiMap = new Map();
            nilaiDocs.forEach(docSnap => {
                if (docSnap.exists()) {
                    nilaiMap.set(docSnap.id, docSnap.data());
                }
            });

            let tableHtml = '';
            siswaList.forEach(siswa => {
                const siswaId = siswa.id;
                currentSiswaNilai.push(siswaId); // Tambahkan ke daftar untuk disimpan
                const nilaiData = nilaiMap.get(siswaId) || {};

                tableHtml += `<tr class="hover:bg-gray-50" data-siswa-id="${siswaId}">`;
                tableHtml += `<td class="px-6 py-4 sticky left-0 bg-white z-10">${siswa.nama}</td>`;
                
                // Tugas 1-10
                for(let i=1; i <= TUGAS_COUNT; i++) {
                    tableHtml += `<td class="px-2 py-2"><input type="number" min="0" max="100" class="input-nilai w-20 border rounded px-2 py-1" data-tipe="tugas" data-index="${i}" value="${nilaiData[`tugas_${i}`] || ''}"></td>`;
                }
                // UTS 1-2
                for(let i=1; i <= UTS_COUNT; i++) {
                    tableHtml += `<td class="px-2 py-2"><input type="number" min="0" max="100" class="input-nilai w-20 border rounded px-2 py-1" data-tipe="uts" data-index="${i}" value="${nilaiData[`uts_${i}`] || ''}"></td>`;
                }
                // UAS 1-2
                for(let i=1; i <= UAS_COUNT; i++) {
                    tableHtml += `<td class="px-2 py-2"><input type="number" min="0" max="100" class="input-nilai w-20 border rounded px-2 py-1" data-tipe="uas" data-index="${i}" value="${nilaiData[`uas_${i}`] || ''}"></td>`;
                }
                
                tableHtml += `<td class="px-6 py-4"><button data-id="${siswaId}" class="btn-simpan-nilai-siswa bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Simpan</button></td>`;
                tableHtml += `</tr>`;
            });

            tbody.innerHTML = tableHtml;

            // Listener untuk tombol simpan per siswa
            document.querySelectorAll('.btn-simpan-nilai-siswa').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const siswaId = e.currentTarget.dataset.id;
                    const row = e.currentTarget.closest('tr');
                    const inputs = row.querySelectorAll('.input-nilai');
                    
                    const nilaiData = {
                        siswaId: siswaId,
                        namaSiswa: row.cells[0].textContent,
                        kelasId: kelasId,
                        updatedAt: serverTimestamp()
                    };

                    inputs.forEach(input => {
                        const tipe = input.dataset.tipe;
                        const index = input.dataset.index;
                        const key = `${tipe}_${index}`;
                        nilaiData[key] = input.valueAsNumber || null; // Simpan sebagai number atau null
                    });

                    try {
                        const nilaiRef = doc(db, getPrivateCollectionPath('nilai'), siswaId);
                        await setDoc(nilaiRef, nilaiData, { merge: true });
                        showConnectionToast(`Nilai ${nilaiData.namaSiswa} tersimpan.`, false);
                    } catch (error) {
                        console.error("Error simpan nilai:", error);
                        showNotification(`Gagal simpan nilai ${nilaiData.namaSiswa}.`, true);
                    }
                });
            });
        }
        
        // === BAGIAN 6: MATERI === (Tidak berubah)
        async function handleTambahMateri(e) {
            e.preventDefault();
            const selectKelas = document.getElementById('materi-pilih-kelas');
            const kelasId = selectKelas.value;
            const namaKelas = selectKelas.options[selectKelas.selectedIndex].text;
            const tanggal = document.getElementById('materi-tanggal').value;
            const topik = document.getElementById('materi-topik').value.trim();
            const catatan = document.getElementById('materi-catatan').value.trim();

            if (!kelasId || !tanggal || !topik || !userId) {
                showNotification("Kelas, Tanggal, dan Topik harus diisi.", true);
                return;
            }

            try {
                await addDoc(collection(db, getPrivateCollectionPath('materi')), {
                    kelasId,
                    namaKelas,
                    tanggal,
                    topik,
                    catatan,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-tambah-materi').reset();
                setInitialDate(); // Kembalikan tanggal ke hari ini
                showNotification("Catatan materi berhasil disimpan.");
            } catch (error) {
                console.error("Error tambah materi:", error);
                showNotification("Gagal menyimpan catatan materi.", true);
            }
        }

        function loadMateri() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('materi')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-materi-container');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada riwayat materi.</p>';
                    return;
                }

                const materiList = [];
                snapshot.forEach(doc => materiList.push({ id: doc.id, ...doc.data() }));
                
                // Urutkan berdasarkan tanggal (terbaru dulu)
                materiList.sort((a, b) => b.tanggal.localeCompare(a.tanggal));

                materiList.forEach(materi => {
                    container.innerHTML += `
                        <div class="p-4 border rounded-lg bg-white">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-semibold text-lg">${materi.topik}</h4>
                                <button data-id="${materi.id}" class="btn-hapus-materi text-red-500 hover:text-red-700">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">${materi.namaKelas} - ${materi.tanggal}</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${materi.catatan}</p>
                        </div>
                    `;
                });

                document.querySelectorAll('.btn-hapus-materi').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation("Yakin ingin menghapus catatan materi ini?", async () => {
                            try {
                                await deleteDoc(doc(db, getPrivateCollectionPath('materi'), id));
                                showNotification("Catatan materi dihapus.");
                            } catch (error) {
                                console.error("Error hapus materi:", error);
                                showNotification("Gagal menghapus materi.", true);
                            }
                        });
                    });
                });
            });
        }

        // === BAGIAN 7: SUMBER BELAJAR === (Tidak berubah)
        async function handleTambahSumber(e) {
            e.preventDefault();
            const judul = document.getElementById('sumber-judul').value.trim();
            const link = document.getElementById('sumber-link').value.trim();
            const deskripsi = document.getElementById('sumber-deskripsi').value.trim();
            const selectKelas = document.getElementById('sumber-belajar-pilih-kelas');
            const kelasId = selectKelas.value;
            const namaKelas = selectKelas.options[selectKelas.selectedIndex].text;
            
            if (!judul || !link || !userId) {
                showNotification("Judul dan Link harus diisi.", true);
                return;
            }

            try {
                await addDoc(collection(db, getPrivateCollectionPath('sumberBelajar')), {
                    judul,
                    link,
                    deskripsi,
                    kelasId, // "semua" atau ID kelas
                    namaKelas, // "Semua Kelas" atau nama kelas
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-tambah-sumber').reset();
                showNotification("Sumber belajar berhasil disimpan.");
            } catch (error) {
                console.error("Error tambah sumber:", error);
                showNotification("Gagal menyimpan sumber belajar.", true);
            }
        }
        
        function loadSumberBelajar() {
            if (!userId) return;
            const q = query(collection(db, getPrivateCollectionPath('sumberBelajar')));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('daftar-sumber-belajar');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Belum ada sumber belajar tersimpan.</p>';
                    return;
                }

                const sumberList = [];
                snapshot.forEach(doc => sumberList.push({ id: doc.id, ...doc.data() }));
                
                // Urutkan berdasarkan waktu (terbaru dulu)
                sumberList.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                sumberList.forEach(sumber => {
                    container.innerHTML += `
                        <div class="p-4 border rounded-lg bg-white">
                            <div class="flex justify-between items-center mb-1">
                                <a href="${sumber.link}" target="_blank" rel="noopener noreferrer" class="font-semibold text-lg text-blue-600 hover:underline">${sumber.judul}</a>
                                <button data-id="${sumber.id}" class="btn-hapus-sumber text-red-500 hover:text-red-700">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </div>
                            <span class="text-xs font-medium py-1 px-2 rounded ${sumber.kelasId === 'semua' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${sumber.namaKelas}</span>
                            <p class="text-gray-700 mt-2">${sumber.deskripsi}</p>
                            <a href="${sumber.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 truncate block mt-1 hover:underline">${sumber.link}</a>
                        </div>
                    `;
                });

                document.querySelectorAll('.btn-hapus-sumber').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation("Yakin ingin menghapus sumber belajar ini?", async () => {
                            try {
                                await deleteDoc(doc(db, getPrivateCollectionPath('sumberBelajar'), id));
                                showNotification("Sumber belajar dihapus.");
                            } catch (error) {
                                console.error("Error hapus sumber:", error);
                                showNotification("Gagal menghapus sumber.", true);
                            }
                        });
                    });
                });
            });
        }
        
        // === BAGIAN 8: CATATAN SISWA (MODAL) === (Tidak berubah)
        async function handleTambahCatatan(e) {
            e.preventDefault();
            const siswaId = document.getElementById('catatan-modal-siswaId').value;
            const namaSiswa = document.getElementById('catatan-modal-namaSiswa').value;
            const kelasId = document.getElementById('catatan-modal-kelasId').value;
            const namaKelas = document.getElementById('catatan-modal-namaKelas').value;
            const catatan = document.getElementById('catatan-modal-input').value.trim();

            if (!siswaId || !catatan || !userId) {
                showNotification("Catatan tidak boleh kosong.", true);
                return;
            }

            try {
                await addDoc(collection(db, getPrivateCollectionPath('catatanSiswa')), {
                    siswaId,
                    namaSiswa,
                    kelasId,
                    namaKelas,
                    catatan,
                    tanggal: new Date().toISOString().split('T')[0], // Catat tanggal hari ini
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-tambah-catatan').reset();
                // loadCatatanSiswa(siswaId); // onSnapshot akan auto-refresh
            } catch (error) {
                console.error("Error tambah catatan:", error);
                showNotification("Gagal menyimpan catatan.", true);
            }
        }
        
        function loadCatatanSiswa(siswaId) {
            if (!userId || !siswaId) return;
            const listContainer = document.getElementById('catatan-modal-list');
            listContainer.innerHTML = '<p class="text-gray-500">Memuat catatan...</p>';
            
            const q = query(collection(db, getPrivateCollectionPath('catatanSiswa')), where("siswaId", "==", siswaId));
            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">Belum ada catatan.</p>';
                    return;
                }

                const catatanList = [];
                snapshot.forEach(doc => catatanList.push({ id: doc.id, ...doc.data() }));

                // Urutkan (terbaru dulu)
                catatanList.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                catatanList.forEach(catatan => {
                    listContainer.innerHTML += `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-600">${catatan.tanggal}</span>
                                <button data-id="${catatan.id}" class="btn-hapus-catatan text-red-500 hover:text-red-700 text-sm">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap">${catatan.catatan}</p>
                        </div>
                    `;
                });

                document.querySelectorAll('.btn-hapus-catatan').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        showConfirmation("Yakin ingin menghapus catatan ini?", async () => {
                            try {
                                await deleteDoc(doc(db, getPrivateCollectionPath('catatanSiswa'), id));
                                // showNotification("Catatan dihapus."); // Tidak perlu, onSnapshot auto-refresh
                            } catch (error) {
                                console.error("Error hapus catatan:", error);
                                showNotification("Gagal menghapus catatan.", true);
                            }
                        });
                    });
                });
            });
        }
        
        // === BAGIAN 9: LAPORAN === (Tidak berubah)
        async function handleBuatLaporan() {
            const tipe = document.getElementById('laporan-tipe').value;
            const kelasId = document.getElementById('laporan-pilih-kelas').value;
            const container = document.getElementById('laporan-output');

            if (!userId) {
                container.innerHTML = '<p class="text-red-500">Gagal: Anda tidak login.</p>';
                return;
            }

            container.innerHTML = '<p class="text-gray-500">Membuat laporan, mohon tunggu...</p>';

            if (tipe === 'nilai') {
                await buatLaporanNilai(kelasId, container);
            } else if (tipe === 'absensi') {
                await buatLaporanAbsensi(kelasId, container);
            }
        }

        async function buatLaporanNilai(kelasId, container) {
            try {
                let tableHtml = `
                    <h3 class="text-xl font-semibold mb-4">Laporan Nilai</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Nama Siswa</th>
                                    <th class="px-4 py-2 text-left">Kelas</th>
                                    ${Array.from({length: TUGAS_COUNT}, (_, i) => `<th class="px-2 py-2">T${i+1}</th>`).join('')}
                                    ${Array.from({length: UTS_COUNT}, (_, i) => `<th class="px-2 py-2">UTS${i+1}</th>`).join('')}
                                    ${Array.from({length: UAS_COUNT}, (_, i) => `<th class="px-2 py-2">UAS${i+1}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                // 1. Ambil data siswa (filter by kelas jika dipilih)
                let siswaQuery = collection(db, getPrivateCollectionPath('siswa'));
                if (kelasId) {
                    siswaQuery = query(siswaQuery, where("kelasId", "==", kelasId));
                }
                const siswaSnap = await getDocs(siswaQuery);
                if (siswaSnap.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada data siswa untuk laporan ini.</p>';
                    return;
                }
                
                const siswaList = [];
                siswaSnap.forEach(doc => siswaList.push({ id: doc.id, ...doc.data() }));
                siswaList.sort((a, b) => a.nama.localeCompare(b.nama)); // Urutkan

                // 2. Ambil data nilai
                const nilaiRefs = siswaList.map(siswa => doc(db, getPrivateCollectionPath('nilai'), siswa.id));
                const nilaiDocs = await Promise.all(nilaiRefs.map(ref => getDoc(ref)));
                const nilaiMap = new Map();
                nilaiDocs.forEach(docSnap => {
                    if (docSnap.exists()) {
                        nilaiMap.set(docSnap.id, docSnap.data());
                    }
                });
                
                // 3. Buat baris tabel
                siswaList.forEach(siswa => {
                    const nilai = nilaiMap.get(siswa.id) || {};
                    tableHtml += `<tr class="text-sm">`;
                    tableHtml += `<td class="px-4 py-2 font-medium">${siswa.nama}</td>`;
                    tableHtml += `<td class="px-4 py-2">${siswa.namaKelas}</td>`;
                    
                    for(let i=1; i <= TUGAS_COUNT; i++) tableHtml += `<td class="px-2 py-2 text-center">${nilai[`tugas_${i}`] || '-'}</td>`;
                    for(let i=1; i <= UTS_COUNT; i++) tableHtml += `<td class="px-2 py-2 text-center">${nilai[`uts_${i}`] || '-'}</td>`;
                    for(let i=1; i <= UAS_COUNT; i++) tableHtml += `<td class="px-2 py-2 text-center">${nilai[`uas_${i}`] || '-'}</td>`;
                    
                    tableHtml += `</tr>`;
                });

                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;

            } catch (error) {
                console.error("Error buat laporan nilai:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan nilai.</p>';
            }
        }
        
        async function buatLaporanAbsensi(kelasId, container) {
            try {
                let tableHtml = `
                    <h3 class="text-xl font-semibold mb-4">Laporan Rekap Absensi</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Nama Siswa</th>
                                    <th class="px-4 py-2 text-left">Kelas</th>
                                    <th class="px-4 py-2 text-left">Hadir</th>
                                    <th class="px-4 py-2 text-left">Izin</th>
                                    <th class="px-4 py-2 text-left">Sakit</th>
                                    <th class="px-4 py-2 text-left">Alfa</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                // 1. Dapatkan semua siswa
                let siswaQuery = collection(db, getPrivateCollectionPath('siswa'));
                if (kelasId) {
                    siswaQuery = query(siswaQuery, where("kelasId", "==", kelasId));
                }
                const siswaSnap = await getDocs(siswaQuery);
                if (siswaSnap.empty) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada data siswa untuk laporan ini.</p>';
                    return;
                }
                
                // Buat rekap
                const rekap = {};
                siswaSnap.forEach(doc => {
                    rekap[doc.id] = {
                        nama: doc.data().nama,
                        kelas: doc.data().namaKelas,
                        H: 0, I: 0, S: 0, A: 0
                    };
                });
                
                // 2. Dapatkan semua data absensi
                let absensiQuery = collection(db, getPrivateCollectionPath('absensi'));
                if (kelasId) {
                    absensiQuery = query(absensiQuery, where("kelasId", "==", kelasId));
                }
                const absensiSnap = await getDocs(absensiQuery);
                
                absensiSnap.forEach(doc => {
                    const statusSiswa = doc.data().status;
                    for (const siswaId in statusSiswa) {
                        if (rekap[siswaId]) { // Jika siswa masih ada
                            const status = statusSiswa[siswaId];
                            if (rekap[siswaId][status] !== undefined) {
                                rekap[siswaId][status]++;
                            }
                        }
                    }
                });

                // 3. Urutkan rekap berdasarkan nama
                let rekapEntries = Object.entries(rekap);
                rekapEntries.sort(([, a], [, b]) => a.nama.localeCompare(b.nama));

                // 4. Buat baris tabel
                for (const [siswaId, data] of rekapEntries) {
                    tableHtml += `
                        <tr>
                            <td class="px-4 py-2">${data.nama}</td>
                            <td class="px-4 py-2">${data.kelas}</td>
                            <td class="px-4 py-2">${data.H}</td>
                            <td class="px-4 py-2">${data.I}</td>
                            <td class="px-4 py-2">${data.S}</td>
                            <td class="px-4 py-2">${data.A}</td>
                        </tr>
                    `;
                }
                
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;

            } catch (error) {
                console.error("Error buat laporan absensi:", error);
                container.innerHTML = '<p class="text-red-500">Gagal membuat laporan absensi.</p>';
            }
        }

    </script>
</body>
</html>
